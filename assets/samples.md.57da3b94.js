import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.f1c0562b.js";const o="/assets/ocup_sb.ab50f876.png",p="/assets/ocup_lua21.0c5ae882.png",e="/assets/astrosettings.2a9847a8.png",t="/assets/toggle_timer.628e3640.png",A=JSON.parse('{"title":"Примеры скриптов","description":"","frontmatter":{},"headers":[],"relativePath":"samples.md","filePath":"samples.md"}'),c={name:"samples.md"},r=l(`<h1 id="примеры-скриптов" tabindex="-1">Примеры скриптов <a class="header-anchor" href="#примеры-скриптов" aria-label="Permalink to &quot;Примеры скриптов&quot;">​</a></h1><p>Приведенные примеры служат исключительно для демонстации построения тех или иных алгоритмов и не отмменяет необходимость в изучении языка программирования LUA.</p><h2 id="скрипт-инициализации" tabindex="-1">Скрипт инициализации <a class="header-anchor" href="#скрипт-инициализации" aria-label="Permalink to &quot;Скрипт инициализации&quot;">​</a></h2><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- init.lua --</span></span>
<span class="line"><span style="color:#6A737D;">-- Таймер. Ежеминутный запуск скрипта для отслеживания юзеров в сети</span></span>
<span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;personesTracker&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;">-- Таймер. Запуск скрипта для каких-либо ежеминутных проверок/действий</span></span>
<span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;flush&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;bowl&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;">-- Уведомление в Telegram о старте шлюза --</span></span>
<span class="line"><span style="color:#E1E4E8;">telegram.</span><span style="color:#79B8FF;">settoken</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;51778***5:AAG0bvK***&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">telegram.</span><span style="color:#79B8FF;">setchat</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;-3348***&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;SLS загружен!!!&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;">--[[</span></span>
<span class="line"><span style="color:#6A737D;">  Уведомление в Telegram о времени восхода и заката солнца.</span></span>
<span class="line"><span style="color:#6A737D;">  Для правильной работы необходимо в системных настройках</span></span>
<span class="line"><span style="color:#6A737D;">  заполнить данные о координатах шлюза в меню Settings -&gt; Time &amp; Location</span></span>
<span class="line"><span style="color:#6A737D;">--]]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunset_hour, sunset_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunset</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunrise_hour, sunrise_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunrise</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;sunrise &quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> sunset_hour </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;:&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> sunset_min)</span></span>
<span class="line"><span style="color:#6A737D;">-- Инициализация объектов для обмена между скриптами --</span></span>
<span class="line"><span style="color:#E1E4E8;">obj.</span><span style="color:#79B8FF;">setType</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;there.is.no.spoon&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;BOOL&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;there.is.no.spoon&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;">-- Привязка скрипта btn_sw1.lua к событию нажатия аппаратной кнопки шлюза --</span></span>
<span class="line"><span style="color:#E1E4E8;">obj.</span><span style="color:#79B8FF;">onChange</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;io.input0.value&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;btn_sw1.lua&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- init.lua --</span></span>
<span class="line"><span style="color:#6A737D;">-- Таймер. Ежеминутный запуск скрипта для отслеживания юзеров в сети</span></span>
<span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;personesTracker&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">60</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;">-- Таймер. Запуск скрипта для каких-либо ежеминутных проверок/действий</span></span>
<span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;flush&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">60</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;bowl&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;">-- Уведомление в Telegram о старте шлюза --</span></span>
<span class="line"><span style="color:#24292E;">telegram.</span><span style="color:#005CC5;">settoken</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;51778***5:AAG0bvK***&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">telegram.</span><span style="color:#005CC5;">setchat</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;-3348***&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;SLS загружен!!!&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;">--[[</span></span>
<span class="line"><span style="color:#6A737D;">  Уведомление в Telegram о времени восхода и заката солнца.</span></span>
<span class="line"><span style="color:#6A737D;">  Для правильной работы необходимо в системных настройках</span></span>
<span class="line"><span style="color:#6A737D;">  заполнить данные о координатах шлюза в меню Settings -&gt; Time &amp; Location</span></span>
<span class="line"><span style="color:#6A737D;">--]]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunset_hour, sunset_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunset</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunrise_hour, sunrise_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunrise</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;sunrise &quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> sunset_hour </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;:&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> sunset_min)</span></span>
<span class="line"><span style="color:#6A737D;">-- Инициализация объектов для обмена между скриптами --</span></span>
<span class="line"><span style="color:#24292E;">obj.</span><span style="color:#005CC5;">setType</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;there.is.no.spoon&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;BOOL&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;there.is.no.spoon&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;">-- Привязка скрипта btn_sw1.lua к событию нажатия аппаратной кнопки шлюза --</span></span>
<span class="line"><span style="color:#24292E;">obj.</span><span style="color:#005CC5;">onChange</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;io.input0.value&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;btn_sw1.lua&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><hr><h2 id="события" tabindex="-1">События <a class="header-anchor" href="#события" aria-label="Permalink to &quot;События&quot;">​</a></h2><h3 id="разбор-всех-своиств-событии" tabindex="-1">Разбор всех свойств событий <a class="header-anchor" href="#разбор-всех-своиств-событии" aria-label="Permalink to &quot;Разбор всех свойств событий&quot;">​</a></h3><p>При разработке сценариев, часто требуется получить все параметры, передаваемые в него через события. Но, не все свойства бывают описаны в документации. Особенно при добавлении в прошивку новых функций или доработке существующих. Для получения и разбора всех свойств, может помочь такой пример:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> key, val </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(Event) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;">(val) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;table&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> key2, val2 </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(val) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Event.&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> key </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;.&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> key2, val2)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Event.&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> key, val)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> key, val </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(Event) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">type</span><span style="color:#24292E;">(val) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;table&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> key2, val2 </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(val) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Event.&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> key </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> key2, val2)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Event.&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> key, val)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>Пример вывода:</p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">[22:28:49.552]</span><span style="color:#E1E4E8;"> [Scripts] Event.State.OldValue true</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.558]</span><span style="color:#E1E4E8;"> [Scripts] Event.State.Name contact</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.563]</span><span style="color:#E1E4E8;"> [Scripts] Event.State.Value false</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.568]</span><span style="color:#E1E4E8;"> [Scripts] Event.Name tables.lua</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.667]</span><span style="color:#E1E4E8;"> [Scripts] Event.Type 1</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.672]</span><span style="color:#E1E4E8;"> [Scripts] Event.Param</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.678]</span><span style="color:#E1E4E8;"> [Scripts] Event.nwkAddr 42108</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.687]</span><span style="color:#E1E4E8;"> [Scripts] Event.Time.min 28</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.694]</span><span style="color:#E1E4E8;"> [Scripts] Event.Time.month 12</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.702]</span><span style="color:#E1E4E8;"> [Scripts] Event.Time.year 2022</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.709]</span><span style="color:#E1E4E8;"> [Scripts] Event.Time.sec 49</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.713]</span><span style="color:#E1E4E8;"> [Scripts] Event.Time.hour 22</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.721]</span><span style="color:#E1E4E8;"> [Scripts] Event.Time.wday 5</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.726]</span><span style="color:#E1E4E8;"> [Scripts] Event.Time.day 9</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.733]</span><span style="color:#E1E4E8;"> [Scripts] Event.ModelId lumi.sensor_magnet</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.738]</span><span style="color:#E1E4E8;"> [Scripts] Event.FreindlyName</span></span>
<span class="line"><span style="color:#B392F0;">[22:28:49.745]</span><span style="color:#E1E4E8;"> [Scripts] Event.ieeeAddr 0x0123456789ABCDEF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">[22:28:49.552]</span><span style="color:#24292E;"> [Scripts] Event.State.OldValue true</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.558]</span><span style="color:#24292E;"> [Scripts] Event.State.Name contact</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.563]</span><span style="color:#24292E;"> [Scripts] Event.State.Value false</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.568]</span><span style="color:#24292E;"> [Scripts] Event.Name tables.lua</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.667]</span><span style="color:#24292E;"> [Scripts] Event.Type 1</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.672]</span><span style="color:#24292E;"> [Scripts] Event.Param</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.678]</span><span style="color:#24292E;"> [Scripts] Event.nwkAddr 42108</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.687]</span><span style="color:#24292E;"> [Scripts] Event.Time.min 28</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.694]</span><span style="color:#24292E;"> [Scripts] Event.Time.month 12</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.702]</span><span style="color:#24292E;"> [Scripts] Event.Time.year 2022</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.709]</span><span style="color:#24292E;"> [Scripts] Event.Time.sec 49</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.713]</span><span style="color:#24292E;"> [Scripts] Event.Time.hour 22</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.721]</span><span style="color:#24292E;"> [Scripts] Event.Time.wday 5</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.726]</span><span style="color:#24292E;"> [Scripts] Event.Time.day 9</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.733]</span><span style="color:#24292E;"> [Scripts] Event.ModelId lumi.sensor_magnet</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.738]</span><span style="color:#24292E;"> [Scripts] Event.FreindlyName</span></span>
<span class="line"><span style="color:#6F42C1;">[22:28:49.745]</span><span style="color:#24292E;"> [Scripts] Event.ieeeAddr 0x0123456789ABCDEF</span></span></code></pre></div><h3 id="включение-режима-сопряжения-по-нажатию-на-кнопку-шлюза" tabindex="-1">Включение режима сопряжения по нажатию на кнопку шлюза <a class="header-anchor" href="#включение-режима-сопряжения-по-нажатию-на-кнопку-шлюза" aria-label="Permalink to &quot;Включение режима сопряжения по нажатию на кнопку шлюза&quot;">​</a></h3><p>По нажатию на аппаратную кнопку будет включаться режим сопряжения (Join) Zigbee устройств.</p><ul><li>в <code>init.lua</code> добавить код:</li></ul><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">obj.</span><span style="color:#79B8FF;">onChange</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;io.input0.value&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;btn_sw1.lua&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">obj.</span><span style="color:#005CC5;">onChange</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;io.input0.value&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;btn_sw1.lua&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><ul><li>создать <code>btn_sw1.lua</code> с кодом:</li></ul><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">join</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;0x0000&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">join</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;0x0000&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="обработка-нажатии-кнопки-и-управление-светом" tabindex="-1">Обработка нажатий кнопки и управление светом <a class="header-anchor" href="#обработка-нажатии-кнопки-и-управление-светом" aria-label="Permalink to &quot;Обработка нажатий кнопки и управление светом&quot;">​</a></h3><h4 id="переключение-света-через-управление-яркостью" tabindex="-1">Переключение света через управление яркостью <a class="header-anchor" href="#переключение-света-через-управление-яркостью" aria-label="Permalink to &quot;Переключение света через управление яркостью&quot;">​</a></h4><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- однократное нажатие, включить свет (яркость max)</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;single&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">255</span></span>
<span class="line"><span style="color:#6A737D;">-- двойное нажатие, выключить свет (яркость 0)</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;double&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#6A737D;">-- другие нажатия - ничего не делать</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#6A737D;">-- непосредственно, отправка полученного значения в целевое устройство</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lamp_1&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">, value)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- однократное нажатие, включить свет (яркость max)</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;single&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">255</span></span>
<span class="line"><span style="color:#6A737D;">-- двойное нажатие, выключить свет (яркость 0)</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;double&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6A737D;">-- другие нажатия - ничего не делать</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#6A737D;">-- непосредственно, отправка полученного значения в целевое устройство</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lamp_1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">, value)</span></span></code></pre></div><h4 id="переключение-света" tabindex="-1">Переключение света <a class="header-anchor" href="#переключение-света" aria-label="Permalink to &quot;Переключение света&quot;">​</a></h4><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;single&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;ON&quot;</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;double&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;OFF&quot;</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lamp_1&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">, value)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;single&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ON&quot;</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;double&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;OFF&quot;</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lamp_1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">, value)</span></span></code></pre></div><hr><h2 id="управление-светом-zigbee" tabindex="-1">Управление светом Zigbee <a class="header-anchor" href="#управление-светом-zigbee" aria-label="Permalink to &quot;Управление светом Zigbee&quot;">​</a></h2><p>Управление свойствами осветительных приборов: получить состояние, включить, выключить, изменить яркость/цвет/цветовую температуру, на примере лампы <code>TS0505B</code></p><h3 id="получить-яркость-цвет-температуру-и-статус" tabindex="-1">Получить яркость, цвет, температуру и статус <a class="header-anchor" href="#получить-яркость-цвет-температуру-и-статус" aria-label="Permalink to &quot;Получить яркость, цвет, температуру и статус&quot;">​</a></h3><ul><li>статус вкл/выкл - state = ON/OFF</li><li>яркость - brightness = 0..255</li><li>текущий режим управления цветом - color_mode = xy (цвет) | color_temp (температура)</li><li>цветовая температура - color_temp = 153..500 по шкале Mired</li><li>цвет - color = значения XYHS в объекте JSON</li><li>скорость нарастания значения при изменении - transition = 1..255 сек</li></ul><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> device </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">brightness </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">color_mode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;color_mode&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">color </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;color&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">color_temp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;color_temp&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">transition </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;transition&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;brightness</span><span style="color:#79B8FF;">\\t</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, brightness)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;color_mode</span><span style="color:#79B8FF;">\\t</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, color_mode)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;color</span><span style="color:#79B8FF;">\\t\\t</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, color)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;color_temp</span><span style="color:#79B8FF;">\\t</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, color_temp)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;state</span><span style="color:#79B8FF;">\\t\\t</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, state)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;transition</span><span style="color:#79B8FF;">\\t</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, transition)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> device </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#24292E;">brightness </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">color_mode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;color_mode&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">color </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;color&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">color_temp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;color_temp&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">transition </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;transition&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;brightness</span><span style="color:#005CC5;">\\t</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, brightness)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;color_mode</span><span style="color:#005CC5;">\\t</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, color_mode)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;color</span><span style="color:#005CC5;">\\t\\t</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, color)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;color_temp</span><span style="color:#005CC5;">\\t</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, color_temp)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;state</span><span style="color:#005CC5;">\\t\\t</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, state)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;transition</span><span style="color:#005CC5;">\\t</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, transition)</span></span></code></pre></div><p>Пример вывода</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">brightness		1</span></span>
<span class="line"><span style="color:#e1e4e8;">color_mode		color_temp</span></span>
<span class="line"><span style="color:#e1e4e8;">color			{&quot;x&quot;:0.696955,&quot;y&quot;:0.299588,&quot;hue&quot;:328.8189,&quot;saturation&quot;:0.716535}</span></span>
<span class="line"><span style="color:#e1e4e8;">color_temp		295</span></span>
<span class="line"><span style="color:#e1e4e8;">state			ON</span></span>
<span class="line"><span style="color:#e1e4e8;">transition		0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">brightness		1</span></span>
<span class="line"><span style="color:#24292e;">color_mode		color_temp</span></span>
<span class="line"><span style="color:#24292e;">color			{&quot;x&quot;:0.696955,&quot;y&quot;:0.299588,&quot;hue&quot;:328.8189,&quot;saturation&quot;:0.716535}</span></span>
<span class="line"><span style="color:#24292e;">color_temp		295</span></span>
<span class="line"><span style="color:#24292e;">state			ON</span></span>
<span class="line"><span style="color:#24292e;">transition		0</span></span></code></pre></div><h3 id="включить-выключить-переключить" tabindex="-1">Включить, выключить, переключить <a class="header-anchor" href="#включить-выключить-переключить" aria-label="Permalink to &quot;Включить, выключить, переключить&quot;">​</a></h3><p>Для управления статусом отправить в состояние <code>state</code></p><ul><li><code>ON</code> - включить</li><li><code>OFF</code> - выключить</li><li><code>TOGGLE</code> - переключить</li></ul><p>При этом устройство включится со значениями яркости, цвета и температуры, установленными ранее.</p><p>Также устройство включится, если отправить любое значение яркости &gt; 0 и выключится если отправить яркость = 0.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> device </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;ON&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- включить</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- выключить</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;TOGGLE&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- переключить</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> device </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;ON&quot;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- включить</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- выключить</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;TOGGLE&quot;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- переключить</span></span></code></pre></div><h3 id="изменить-яркость" tabindex="-1">Изменить яркость <a class="header-anchor" href="#изменить-яркость" aria-label="Permalink to &quot;Изменить яркость&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> device </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- установить яркость на 10%. Если лампа выключена - включится</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- выключить</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> device </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">25</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- установить яркость на 10%. Если лампа выключена - включится</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- выключить</span></span></code></pre></div><h3 id="изменить-цветовую-температуру" tabindex="-1">Изменить цветовую температуру <a class="header-anchor" href="#изменить-цветовую-температуру" aria-label="Permalink to &quot;Изменить цветовую температуру&quot;">​</a></h3><p>Управление цветовой температурой осуществляется по шкале Mired. Для конвертации можно воспользоваться формулой:</p><p><code>color_temp_mired = 1000000 / color_temp_kelvin</code></p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> device </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> color_temp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1000000</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">4700</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;color_temp&quot;</span><span style="color:#E1E4E8;">, color_temp) </span><span style="color:#6A737D;">-- установить цаветовую температуру 4700 Кельвин</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> device </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> color_temp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000000</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">4700</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;color_temp&quot;</span><span style="color:#24292E;">, color_temp) </span><span style="color:#6A737D;">-- установить цаветовую температуру 4700 Кельвин</span></span></code></pre></div><h3 id="изменить-цвет" tabindex="-1">Изменить цвет <a class="header-anchor" href="#изменить-цвет" aria-label="Permalink to &quot;Изменить цвет&quot;">​</a></h3><p>Для изменения цвета можно отправлять значения в следующих форматах:</p><ul><li><code>color</code> основные цвета, например &quot;red&quot;</li><li><code>xy</code>, например &#39;{&quot;x&quot;:0.697,&quot;y&quot;:0.3}&#39;</li><li><code>hue, saturation</code>, например &#39;{&quot;hue&quot;:328.82,&quot;saturation&quot;:0.717}&#39;</li><li><code>hue</code>, например &#39;{&quot;hue&quot;:328.82}&#39;</li><li><code>saturation</code>, например &#39;{&quot;saturation&quot;:0.717}&#39;</li><li><code>hex</code>, например &#39;{&quot;hex&quot;: &quot;#RRGGBB&quot;}&#39;</li><li><code>rgb</code>, например &#39;{&quot;r&quot;:200,&quot;g&quot;:0,&quot;b&quot;:0}&#39;</li></ul><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> device </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> color_xy </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{&quot;x&quot;:0.697,&quot;y&quot;:0.3}&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;color&quot;</span><span style="color:#E1E4E8;">, color_xy)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> device </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> color_xy </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{&quot;x&quot;:0.697,&quot;y&quot;:0.3}&#39;</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;color&quot;</span><span style="color:#24292E;">, color_xy)</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> device </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> color_rgb </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{&quot;r&quot;:200,&quot;g&quot;:0,&quot;b&quot;:0}&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;color&quot;</span><span style="color:#E1E4E8;">, color_rgb)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> device </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> color_rgb </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{&quot;r&quot;:200,&quot;g&quot;:0,&quot;b&quot;:0}&#39;</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;color&quot;</span><span style="color:#24292E;">, color_rgb)</span></span></code></pre></div><h3 id="изменить-плавность-управления" tabindex="-1">Изменить плавность управления <a class="header-anchor" href="#изменить-плавность-управления" aria-label="Permalink to &quot;Изменить плавность управления&quot;">​</a></h3><p>Плавность изменения режимов, например яркости, управляется состоянием <code>transition</code> - время в секундах, в течение которого будет происходить изменение установленного значения</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> device </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;transition&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- при изменении значения, например яркости, последняя будет нарастать от текущего значения до установленного в течение 3 секунд</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> device </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0xA4C138FD68EAA226&quot;</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;transition&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- при изменении значения, например яркости, последняя будет нарастать от текущего значения до установленного в течение 3 секунд</span></span></code></pre></div><hr><h2 id="zigbee" tabindex="-1">Zigbee <a class="header-anchor" href="#zigbee" aria-label="Permalink to &quot;Zigbee&quot;">​</a></h2><h3 id="включение-режим-сопряжения-для-подключения-новых-устроиств-через-роутер" tabindex="-1">Включение режим сопряжения для подключения новых устройств, через роутер <a class="header-anchor" href="#включение-режим-сопряжения-для-подключения-новых-устроиств-через-роутер" aria-label="Permalink to &quot;Включение режим сопряжения для подключения новых устройств, через роутер&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- включить JOIN через роутер &quot;plug1&quot;, на 255 секунд</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">join</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;plug1&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- включить JOIN через роутер &quot;plug1&quot;, на 255 секунд</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">join</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;plug1&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="получение-значения-состояния-устроиства-из-кэша" tabindex="-1">Получение значения состояния устройства из кэша <a class="header-anchor" href="#получение-значения-состояния-устроиства-из-кэша" aria-label="Permalink to &quot;Получение значения состояния устройства из кэша&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- Получаем значение температуры и округляем до целого</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> device </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;FriendlyName&quot; </span><span style="color:#6A737D;">-- также можно использовать ieeeAddr и nwkAddr</span></span>
<span class="line"><span style="color:#E1E4E8;">temp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(device, </span><span style="color:#9ECBFF;">&quot;temperature&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">temp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">math.floor</span><span style="color:#E1E4E8;">(temp)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Текущая температура: &quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> temp </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; C°&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- Получаем значение температуры и округляем до целого</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> device </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;FriendlyName&quot; </span><span style="color:#6A737D;">-- также можно использовать ieeeAddr и nwkAddr</span></span>
<span class="line"><span style="color:#24292E;">temp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(device, </span><span style="color:#032F62;">&quot;temperature&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">temp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">math.floor</span><span style="color:#24292E;">(temp)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Текущая температура: &quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> temp </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; C°&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="вызов-команды-get-в-конвертере" tabindex="-1">Вызов команды GET в конвертере <a class="header-anchor" href="#вызов-команды-get-в-конвертере" aria-label="Permalink to &quot;Вызов команды GET в конвертере&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- Вызов команды GET в конвертере для состояния brightness, устройства с FriendlyName lamPochka</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lamPochka&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- Вызов команды GET в конвертере для состояния brightness, устройства с FriendlyName lamPochka</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lamPochka&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="переключение-лампочки-при-нажатии-кнопки-выключателя" tabindex="-1">Переключение лампочки при нажатии кнопки выключателя <a class="header-anchor" href="#переключение-лампочки-при-нажатии-кнопки-выключателя" aria-label="Permalink to &quot;Переключение лампочки при нажатии кнопки выключателя&quot;">​</a></h3><ul><li>при нажатии кнопки выключателя переключает лампу lamp_1 через контроль яркости. Может выполняться как самостоятельно, например по таймеру, так и из правила Simple Bind</li></ul><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- получаем значение состояния &#39;click&#39; кнопки &#39;lumi.sensor_switch&#39;</span></span>
<span class="line"><span style="color:#6A737D;">-- если значение = single</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lumi.sensor_switch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;click&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;single&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- переключаем (toggle) лампу</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- получим текущее значение яркости лампы</span></span>
<span class="line"><span style="color:#E1E4E8;">  current_brightness </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lamp_1&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- если лампа выключена (яркость = 0)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> current_brightness </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- включим её</span></span>
<span class="line"><span style="color:#E1E4E8;">    zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lamp_1&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- если включена (значение яркости отлично от 0)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- включим</span></span>
<span class="line"><span style="color:#E1E4E8;">    zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lamp_1&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- получаем значение состояния &#39;click&#39; кнопки &#39;lumi.sensor_switch&#39;</span></span>
<span class="line"><span style="color:#6A737D;">-- если значение = single</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lumi.sensor_switch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;click&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;single&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- переключаем (toggle) лампу</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- получим текущее значение яркости лампы</span></span>
<span class="line"><span style="color:#24292E;">  current_brightness </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lamp_1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- если лампа выключена (яркость = 0)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> current_brightness </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- включим её</span></span>
<span class="line"><span style="color:#24292E;">    zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lamp_1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- если включена (значение яркости отлично от 0)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- включим</span></span>
<span class="line"><span style="color:#24292E;">    zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lamp_1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><ul><li>при нажатии кнопки переключает лампу 0x00124B0009FE36FC, через установку состояния &quot;State&quot; в &quot;TOGGLE&quot;. Должен выполняться из SB Rule</li></ul><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;single&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">   zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x00124B0009FE36FC&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;toggle&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;single&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">   zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x00124B0009FE36FC&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;toggle&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span></code></pre></div><h3 id="создание-виртуальных-своиств-устроиства" tabindex="-1">Создание виртуальных свойств устройства <a class="header-anchor" href="#создание-виртуальных-своиств-устроиства" aria-label="Permalink to &quot;Создание виртуальных свойств устройства&quot;">​</a></h3><p>Пример инициализации с сохранением данных</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> res</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">setState</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;prop_float&quot;</span><span style="color:#E1E4E8;">, floatVal, </span><span style="color:#9ECBFF;">&quot;FLOAT&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> res</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">setState</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;prop_bool&quot;</span><span style="color:#E1E4E8;">, boolVal, </span><span style="color:#9ECBFF;">&quot;BOOL&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> res</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">setState</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;prop_int&quot;</span><span style="color:#E1E4E8;">, intVal, </span><span style="color:#9ECBFF;">&quot;INT&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> res</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">setState</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;prop_int&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;strVal&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;STR&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">os.</span><span style="color:#79B8FF;">save</span><span style="color:#E1E4E8;">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> res</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">setState</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;prop_float&quot;</span><span style="color:#24292E;">, floatVal, </span><span style="color:#032F62;">&quot;FLOAT&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> res</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">setState</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;prop_bool&quot;</span><span style="color:#24292E;">, boolVal, </span><span style="color:#032F62;">&quot;BOOL&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> res</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">setState</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;prop_int&quot;</span><span style="color:#24292E;">, intVal, </span><span style="color:#032F62;">&quot;INT&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> res</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">setState</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;prop_int&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;strVal&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;STR&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">os.</span><span style="color:#005CC5;">save</span><span style="color:#24292E;">()</span></span></code></pre></div><h3 id="преобразование-показателеи-давления-из-kpa-в-mmhg" tabindex="-1">Преобразование показателей давления из kPa в mmhg <a class="header-anchor" href="#преобразование-показателеи-давления-из-kpa-в-mmhg" aria-label="Permalink to &quot;Преобразование показателей давления из kPa в mmhg&quot;">​</a></h3><p>Необходимо создать lua скрипт и назначить его вызов при изменении pressure в правило SB:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- kPa2mmhg.lua</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> pressure </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;pressure&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">setState</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;pressure_mm&quot;</span><span style="color:#E1E4E8;">, pressure </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.75</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;FLOAT&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- kPa2mmhg.lua</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> pressure </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;pressure&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">setState</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;pressure_mm&quot;</span><span style="color:#24292E;">, pressure </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.75</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;FLOAT&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>Второй вариант. Сразу записать правило в такм виде:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">#</span><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">setState</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;pressure_mm&quot;</span><span style="color:#E1E4E8;">, zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;pressure&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.75</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;FLOAT&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">#</span><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">setState</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;pressure_mm&quot;</span><span style="color:#24292E;">, zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;pressure&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.75</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;FLOAT&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><hr><h2 id="библиотека-yeelight" tabindex="-1">Библиотека Yeelight <a class="header-anchor" href="#библиотека-yeelight" aria-label="Permalink to &quot;Библиотека Yeelight&quot;">​</a></h2><p>Управляет устройством Yeelight. <a href="https://www.yeelight.com/download/Yeelight_Inter-Operation_Spec.pdf" target="_blank" rel="noreferrer">Описание протокола</a></p><h3 id="получить-текущии-статус" tabindex="-1">Получить текущий статус <a class="header-anchor" href="#получить-текущии-статус" aria-label="Permalink to &quot;Получить текущий статус&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> yeelight.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.0.100&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;get_prop&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;[&quot;power&quot;,&quot;not_exist&quot;,&quot;bright&quot;]&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> yeelight.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.0.100&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;get_prop&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;[&quot;power&quot;,&quot;not_exist&quot;,&quot;bright&quot;]&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>Результат</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#79B8FF;">&quot;id&quot;</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">&quot;result&quot;</span><span style="color:#E1E4E8;">:{</span><span style="color:#79B8FF;">&quot;on&quot;</span><span style="color:#FDAEB7;font-style:italic;">,</span><span style="color:#79B8FF;">&quot;&quot;</span><span style="color:#FDAEB7;font-style:italic;">,</span><span style="color:#79B8FF;">&quot;100&quot;</span><span style="color:#E1E4E8;">}}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{</span><span style="color:#005CC5;">&quot;id&quot;</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">&quot;result&quot;</span><span style="color:#24292E;">:{</span><span style="color:#005CC5;">&quot;on&quot;</span><span style="color:#B31D28;font-style:italic;">,</span><span style="color:#005CC5;">&quot;&quot;</span><span style="color:#B31D28;font-style:italic;">,</span><span style="color:#005CC5;">&quot;100&quot;</span><span style="color:#24292E;">}}</span></span></code></pre></div><h3 id="переключить" tabindex="-1">Переключить <a class="header-anchor" href="#переключить" aria-label="Permalink to &quot;Переключить&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> yeelight.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.0.100&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;toggle&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;[]&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> yeelight.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.0.100&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;toggle&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;[]&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>Результат</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{ </span><span style="color:#79B8FF;">&quot;method&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;props&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">&quot;params&quot;</span><span style="color:#E1E4E8;">: { </span><span style="color:#79B8FF;">&quot;power&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;off&quot;</span><span style="color:#E1E4E8;"> } }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{ </span><span style="color:#005CC5;">&quot;method&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;props&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">&quot;params&quot;</span><span style="color:#24292E;">: { </span><span style="color:#005CC5;">&quot;power&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;off&quot;</span><span style="color:#24292E;"> } }</span></span></code></pre></div><h3 id="установить-яркость" tabindex="-1">Установить яркость <a class="header-anchor" href="#установить-яркость" aria-label="Permalink to &quot;Установить яркость&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> yeelight.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.0.100&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;set_bright&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;[100,&quot;smooth&quot;,500]&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> yeelight.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.0.100&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;set_bright&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;[100,&quot;smooth&quot;,500]&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>Результат</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{ </span><span style="color:#79B8FF;">&quot;method&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;props&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">&quot;params&quot;</span><span style="color:#E1E4E8;">: { </span><span style="color:#79B8FF;">&quot;active_bright&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">&quot;bright&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> } }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{ </span><span style="color:#005CC5;">&quot;method&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;props&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">&quot;params&quot;</span><span style="color:#24292E;">: { </span><span style="color:#005CC5;">&quot;active_bright&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">&quot;bright&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> } }</span></span></code></pre></div><h2 id="библиотека-os" tabindex="-1">Библиотека OS <a class="header-anchor" href="#библиотека-os" aria-label="Permalink to &quot;Библиотека OS&quot;">​</a></h2><h3 id="получение-текущего-часа-времени-и-секунд-например-для-планировщика-в-таимере" tabindex="-1">Получение текущего часа, времени и секунд, например для планировщика в таймере <a class="header-anchor" href="#получение-текущего-часа-времени-и-секунд-например-для-планировщика-в-таимере" aria-label="Permalink to &quot;Получение текущего часа, времени и секунд, например для планировщика в таймере&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> gmt </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- часовой пояс</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> gmt </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3600</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> t1 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">math.modf</span><span style="color:#E1E4E8;">(time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sec  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> t1</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> t1;</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> t1 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">math.modf</span><span style="color:#E1E4E8;">(time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> min  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> t1</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> t1;</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> t1 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">math.modf</span><span style="color:#E1E4E8;">(time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hour </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> t1</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(hour </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;:&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> min </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;:&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> sec)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> gmt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- часовой пояс</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> gmt </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3600</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> t1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">math.modf</span><span style="color:#24292E;">(time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">60</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sec  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> t1</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">60</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> t1;</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> t1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">math.modf</span><span style="color:#24292E;">(time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">60</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> min  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> t1</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">60</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> t1;</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> t1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">math.modf</span><span style="color:#24292E;">(time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">24</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hour </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> t1</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">24</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(hour </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;:&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> min </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;:&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> sec)</span></span></code></pre></div><h2 id="включение-освещения-по-датчику-движения-и-выключение-через-определенное-время" tabindex="-1">Включение освещения по датчику движения и выключение через определенное время <a class="header-anchor" href="#включение-освещения-по-датчику-движения-и-выключение-через-определенное-время" aria-label="Permalink to &quot;Включение освещения по датчику движения и выключение через определенное время&quot;">​</a></h2><p>Такой сценарий легко решается без использования lua скриптов. Разберем пример из датчка движения Aqara lumi.sensor_motion и исполнительного реле на 8 каналов с <a href="https://modkam.ru/?p=1638" target="_blank" rel="noreferrer">modkam</a>.</p><h3 id="вариант-1-с-использованием-команд-simplebind" tabindex="-1">Вариант 1 с использованием команд <a href="/simplebind">SimpleBind</a> <a class="header-anchor" href="#вариант-1-с-использованием-команд-simplebind" aria-label="Permalink to &quot;Вариант 1 с использованием команд [SimpleBind](/simplebind.md)&quot;">​</a></h3><p>На вкладке датчика движения настраиваем при включении occupation=true будет включать освещение, при occupation=false соответственно выключать.</p><p>Пример команды SimpleBind для включения реле по датчику движения:</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">true,0x00124B001F7CA144,state_l1,ON;false,0x00124B001F7CA144,state_l1,OFF;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">true,0x00124B001F7CA144,state_l1,ON;false,0x00124B001F7CA144,state_l1,OFF;</span></span></code></pre></div><p><img src="`+o+`" alt="ocup_sb"></p><p>С помощью occupancy_timeout можно задать интервал, в течении которого будет сбрасываться значение датчика.</p><h3 id="вариант-2-с-использованием-значении-датчика-освещения-и-сценариев-lua" tabindex="-1">Вариант 2 с использованием значений датчика освещения и сценариев <a href="/lua">lua</a> <a class="header-anchor" href="#вариант-2-с-использованием-значении-датчика-освещения-и-сценариев-lua" aria-label="Permalink to &quot;Вариант 2 с использованием значений датчика освещения и сценариев [lua](/lua.md)&quot;">​</a></h3><p>В данном примере мы будем использовать датчик движения Aqara lumi.sensor_motion.aq2 со встроенным датчиком освещенности и исполнительное реле на 8 каналов с <a href="https://modkam.ru/?p=1638" target="_blank" rel="noreferrer">modkam</a>.</p><p>Создаем сценарий occupancy.lua</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;occupancy&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> lightlevel </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;illuminance&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> minlightlevel </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">300</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- зададим минимальный уровень освещенности, когда необходимо включать освещение</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (state) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Датчик движения &quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">FriendlyName</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot; обнаружил активность&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (lightlevel </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> minlightlevel) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;state_l2&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;ON&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Свет в комнате &quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">FriendlyName</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot; включили&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">  telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Значение датчика движения &quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">  Event.</span><span style="color:#B392F0;">FriendlyName</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;  нормализовалось&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (lightlevel </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> minlightlevel) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;state_l2&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Свет в комнате &quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">FriendlyName</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot; выключили&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;occupancy&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> lightlevel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;illuminance&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> minlightlevel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">300</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- зададим минимальный уровень освещенности, когда необходимо включать освещение</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (state) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Датчик движения &quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">FriendlyName</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot; обнаружил активность&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (lightlevel </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> minlightlevel) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;state_l2&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;ON&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Свет в комнате &quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">FriendlyName</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot; включили&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">  telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Значение датчика движения &quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">  Event.</span><span style="color:#6F42C1;">FriendlyName</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;  нормализовалось&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (lightlevel </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> minlightlevel) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x00124B001F7CA144&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;state_l2&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Свет в комнате &quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">FriendlyName</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot; выключили&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>На вкладке датчика движения привязываем сценарий</p><p><img src="`+p+'" alt="ocup_lua21"></p><h3 id="вариант-3-с-использованием-астротаимера-и-сценариев-lua" tabindex="-1">Вариант 3 с использованием астротаймера и сценариев <a href="/lua">lua</a> <a class="header-anchor" href="#вариант-3-с-использованием-астротаимера-и-сценариев-lua" aria-label="Permalink to &quot;Вариант 3 с использованием астротаймера и сценариев [lua](/lua.md)&quot;">​</a></h3><p>В данном примере мы будем использовать любой датчик движения, а в качестве определения необходимости включения освещения будем использовать астро-таймер, встроенный в SLS шлюз. Управлять будем реле на 8 каналов с <a href="https://modkam.ru/?p=1638" target="_blank" rel="noreferrer">modkam</a>. Перед использованнием астротаймера, не забудьте в настройках системы указать ваши коодинаты:</p><p><img src="'+e+`" alt="astrosettings"></p><p>Создаем сценарий occupancy_astro.lua</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;occupancy&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunset_hour, sunset_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunset</span><span style="color:#E1E4E8;">() </span><span style="color:#6A737D;">--закат</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunrise_hour, sunrise_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunrise</span><span style="color:#E1E4E8;">() </span><span style="color:#6A737D;">--рассвет</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Param</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;">  x </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string.gmatch</span><span style="color:#E1E4E8;">(str,</span><span style="color:#9ECBFF;">&#39;([^:]+)&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">table.insert</span><span style="color:#E1E4E8;">(p, x)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ieee</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">p[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> par</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">p[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">setState</span><span style="color:#E1E4E8;">(ieee, par </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_activate_on&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;STR&quot;</span><span style="color:#E1E4E8;">)  </span><span style="color:#6A737D;">--добавляем переменную для хранения информации, что управляемый сенсор включен датчиком движения</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (state) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- следует учитывать, что если тип переменной STR, то проверяется ее наличие, а не булево значение</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> sunset_hour </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> sunrise_hour  </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--если выключен, мы его включаем и записываем, кто включил</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(ieee, par) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">)      </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee, par, </span><span style="color:#9ECBFF;">&quot;ON&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee, par </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_activate_on&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;PIR&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> sunset_hour </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> sunrise_hour   </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--проверяем, если включен не датчиком движений PIR, то не трогаем</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(ieee, par </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_activate_on&quot;</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;PIR&quot;    </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee, par, </span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee, par </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_activate_on&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;occupancy&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunset_hour, sunset_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunset</span><span style="color:#24292E;">() </span><span style="color:#6A737D;">--закат</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunrise_hour, sunrise_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunrise</span><span style="color:#24292E;">() </span><span style="color:#6A737D;">--рассвет</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Param</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;">  x </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string.gmatch</span><span style="color:#24292E;">(str,</span><span style="color:#032F62;">&#39;([^:]+)&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">table.insert</span><span style="color:#24292E;">(p, x)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ieee</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">p[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> par</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">p[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">setState</span><span style="color:#24292E;">(ieee, par </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_activate_on&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;STR&quot;</span><span style="color:#24292E;">)  </span><span style="color:#6A737D;">--добавляем переменную для хранения информации, что управляемый сенсор включен датчиком движения</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (state) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- следует учитывать, что если тип переменной STR, то проверяется ее наличие, а не булево значение</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> sunset_hour </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> sunrise_hour  </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">--если выключен, мы его включаем и записываем, кто включил</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(ieee, par) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">)      </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee, par, </span><span style="color:#032F62;">&quot;ON&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee, par </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_activate_on&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;PIR&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> sunset_hour </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> sunrise_hour   </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--проверяем, если включен не датчиком движений PIR, то не трогаем</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(ieee, par </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_activate_on&quot;</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;PIR&quot;    </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee, par, </span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee, par </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_activate_on&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>Для корректной работы сценария, необходимо передать два параметра через двоеточие, наример: occupancy_astro.lua,0x00124B001F7CA144:state_l1. Сценарий запоминает, что свет включен по датчику движения, и выключает только в том случае, если был включен по датчику движения.</p><h3 id="вариант-4-привязка-нескольких-устроиств-с-использованием-астротаимера-и-сценариев-lua" tabindex="-1">Вариант 4. Привязка нескольких устройств с использованием астротаймера и сценариев <a href="/lua">lua</a> <a class="header-anchor" href="#вариант-4-привязка-нескольких-устроиств-с-использованием-астротаимера-и-сценариев-lua" aria-label="Permalink to &quot;Вариант 4. Привязка нескольких устройств с использованием астротаймера и сценариев [lua](/lua.md)&quot;">​</a></h3><p>При вызове lua скрипта необходимо в виде параметров передать список привязываемых устройств. Пример параметров:</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">occupancy_astro2.lua,0x00124B001EC83D62:state_l4/0x00124B001EC83D62:state_l2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">occupancy_astro2.lua,0x00124B001EC83D62:state_l4/0x00124B001EC83D62:state_l2</span></span></code></pre></div><p>Пример сценария occupancy_astro2.lua</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;occupancy&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunset_hour, sunset_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunset</span><span style="color:#E1E4E8;">() </span><span style="color:#6A737D;">--закат</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunrise_hour, sunrise_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunrise</span><span style="color:#E1E4E8;">() </span><span style="color:#6A737D;">--рассвет</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> str</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">Event.</span><span style="color:#B392F0;">Param</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;">  x1 </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string.gmatch</span><span style="color:#E1E4E8;">(str,</span><span style="color:#9ECBFF;">&#39;([^/]+)&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;">  x2 </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string.gmatch</span><span style="color:#E1E4E8;">(x1,</span><span style="color:#9ECBFF;">&#39;([^:]+)&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">table.insert</span><span style="color:#E1E4E8;">(p, x2)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ieee</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">p[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> par</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">p[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">setState</span><span style="color:#E1E4E8;">(ieee, par </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_activate_on&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;STR&quot;</span><span style="color:#E1E4E8;">)  </span><span style="color:#6A737D;">--добавляем переменную для хранения информации, что управляемый сенсор включен датчиком движения</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (state) </span><span style="color:#F97583;">then</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> sunset_hour </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> sunrise_hour  </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--если выключен, мы его включаем и записываем, кто включил</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(ieee, par)</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">)      </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee, par, </span><span style="color:#9ECBFF;">&quot;ON&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee, par</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;_activate_on&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;PIR&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--telegram.send(&quot;Свет в комнате &quot;.. Event.FriendlyName  ..&quot; включили (&quot;..par..&quot;)&quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> sunset_hour </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> sunrise_hour   </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--проверяем, если включен не датчиком движений PIR, то не трогаем</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(ieee, par</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;_activate_on&quot;</span><span style="color:#E1E4E8;">) )</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&quot;PIR&quot;    </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee, par, </span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee, par</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;_activate_on&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">--telegram.send(&quot;Свет в комнате &quot;.. Event.FriendlyName  ..&quot; выключили&quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;occupancy&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunset_hour, sunset_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunset</span><span style="color:#24292E;">() </span><span style="color:#6A737D;">--закат</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunrise_hour, sunrise_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunrise</span><span style="color:#24292E;">() </span><span style="color:#6A737D;">--рассвет</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> str</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">Event.</span><span style="color:#6F42C1;">Param</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;">  x1 </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string.gmatch</span><span style="color:#24292E;">(str,</span><span style="color:#032F62;">&#39;([^/]+)&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;">  x2 </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string.gmatch</span><span style="color:#24292E;">(x1,</span><span style="color:#032F62;">&#39;([^:]+)&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#005CC5;">table.insert</span><span style="color:#24292E;">(p, x2)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ieee</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">p[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> par</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">p[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">setState</span><span style="color:#24292E;">(ieee, par </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_activate_on&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;STR&quot;</span><span style="color:#24292E;">)  </span><span style="color:#6A737D;">--добавляем переменную для хранения информации, что управляемый сенсор включен датчиком движения</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (state) </span><span style="color:#D73A49;">then</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> sunset_hour </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> sunrise_hour  </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">--если выключен, мы его включаем и записываем, кто включил</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(ieee, par)</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">)      </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee, par, </span><span style="color:#032F62;">&quot;ON&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee, par</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;_activate_on&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;PIR&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--telegram.send(&quot;Свет в комнате &quot;.. Event.FriendlyName  ..&quot; включили (&quot;..par..&quot;)&quot;)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> sunset_hour </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> sunrise_hour   </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">--проверяем, если включен не датчиком движений PIR, то не трогаем</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(ieee, par</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;_activate_on&quot;</span><span style="color:#24292E;">) )</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&quot;PIR&quot;    </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee, par, </span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee, par</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;_activate_on&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">--telegram.send(&quot;Свет в комнате &quot;.. Event.FriendlyName  ..&quot; выключили&quot;)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h3 id="уведомление-в-телеграм-об-открытии-двери" tabindex="-1">Уведомление в телеграм об открытии двери <a class="header-anchor" href="#уведомление-в-телеграм-об-открытии-двери" aria-label="Permalink to &quot;Уведомление в телеграм об открытии двери&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">~=</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">OldValue</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Дверь закрыта&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">    telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Дверь открыта&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">~=</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">OldValue</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Дверь закрыта&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">    telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Дверь открыта&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h3 id="оповещение-в-телеграм-при-сработке-датчика-движения" tabindex="-1">Оповещение в телеграм при сработке датчика движения <a class="header-anchor" href="#оповещение-в-телеграм-при-сработке-датчика-движения" aria-label="Permalink to &quot;Оповещение в телеграм при сработке датчика движения&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;occupancy&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (state) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Датчик движения &quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot; обнаружил активность&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">  telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Значение датчика &quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">FriendlyName</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot; движения нормализовалось&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;occupancy&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (state) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Датчик движения &quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot; обнаружил активность&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">  telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Значение датчика &quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">FriendlyName</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot; движения нормализовалось&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h3 id="оповещение-об-изменении-значения-датчика-температуры-влажности" tabindex="-1">Оповещение об изменении значения датчика температуры/влажности <a class="header-anchor" href="#оповещение-об-изменении-значения-датчика-температуры-влажности" aria-label="Permalink to &quot;Оповещение об изменении значения датчика температуры/влажности&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> temp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">round2</span><span style="color:#E1E4E8;">(zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;temperature&quot;</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hum </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">round2</span><span style="color:#E1E4E8;">(zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;humidity&quot;</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Значение ДТВ &quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">FriendlyName</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; &quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> temp</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;° / &quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> hum </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;%&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> temp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">round2</span><span style="color:#24292E;">(zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;temperature&quot;</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hum </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">round2</span><span style="color:#24292E;">(zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;humidity&quot;</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Значение ДТВ &quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">FriendlyName</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; &quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> temp</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;° / &quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> hum </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;%&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="подсветка-шлюза-по-датчику-движению-только-в-ночное-время-с-22-до-6" tabindex="-1">Подсветка шлюза по датчику движению только в ночное время с 22 до 6 <a class="header-anchor" href="#подсветка-шлюза-по-датчику-движению-только-в-ночное-время-с-22-до-6" aria-label="Permalink to &quot;Подсветка шлюза по датчику движению только в ночное время с 22 до 6&quot;">​</a></h3><p>Вариант через GPIO</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> gmt </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hour </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">math.modf</span><span style="color:#E1E4E8;">(time </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3600</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> gmt) </span><span style="color:#F97583;">%</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">24</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> hour </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> hour </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    gpio.</span><span style="color:#79B8FF;">pwm</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    gpio.</span><span style="color:#79B8FF;">pwm</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    gpio.</span><span style="color:#79B8FF;">pwm</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">    gpio.</span><span style="color:#79B8FF;">pwm</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    gpio.</span><span style="color:#79B8FF;">pwm</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    gpio.</span><span style="color:#79B8FF;">pwm</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> gmt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hour </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">math.modf</span><span style="color:#24292E;">(time </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3600</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> gmt) </span><span style="color:#D73A49;">%</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">24</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> hour </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">22</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> hour </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    gpio.</span><span style="color:#005CC5;">pwm</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    gpio.</span><span style="color:#005CC5;">pwm</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    gpio.</span><span style="color:#005CC5;">pwm</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">    gpio.</span><span style="color:#005CC5;">pwm</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    gpio.</span><span style="color:#005CC5;">pwm</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    gpio.</span><span style="color:#005CC5;">pwm</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>Вариант через MQTT:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> gmt </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hour </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">math.modf</span><span style="color:#E1E4E8;">(time </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3600</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> gmt) </span><span style="color:#F97583;">%</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">24</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> hour </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> hour </span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    mqtt.</span><span style="color:#79B8FF;">pub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ZigBeeSls/led&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;{&quot;mode&quot;:&quot;manual&quot;,&quot;hex&quot;:&quot;#FF0000&quot;}&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">    mqtt.</span><span style="color:#79B8FF;">pub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ZigBeeSls/led&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;{&quot;mode&quot;: &quot;off&quot;}&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> gmt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hour </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">math.modf</span><span style="color:#24292E;">(time </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3600</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> gmt) </span><span style="color:#D73A49;">%</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">24</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> hour </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">22</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> hour </span><span style="color:#D73A49;">&lt;</span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    mqtt.</span><span style="color:#005CC5;">pub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;ZigBeeSls/led&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;{&quot;mode&quot;:&quot;manual&quot;,&quot;hex&quot;:&quot;#FF0000&quot;}&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">    mqtt.</span><span style="color:#005CC5;">pub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;ZigBeeSls/led&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;{&quot;mode&quot;: &quot;off&quot;}&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h3 id="создание-режима-охраны" tabindex="-1">Создание режима охраны <a class="header-anchor" href="#создание-режима-охраны" aria-label="Permalink to &quot;Создание режима охраны&quot;">​</a></h3><p>Постановка</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;security_status&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;armed&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;security_status&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;armed&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>Проверка</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;security_status&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;armed&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Объект на охране.&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Объект не на охране.&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;security_status&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;armed&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Объект на охране.&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Объект не на охране.&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h3 id="пример-работы-с-астротаимером" tabindex="-1">Пример работы с астротаймером <a class="header-anchor" href="#пример-работы-с-астротаимером" aria-label="Permalink to &quot;Пример работы с астротаймером&quot;">​</a></h3><p>Астротаймером называется обычный таймер, имеющий привязку к циклам захода\\восхода солнца. Так как на разной широте время захода и восхода отличается, то в таких таймерах присутствует установка долготы/широты. Параметры долготы/широты задаются через Web на вкладке <code>Settings-&gt;Location</code></p><p>Астротаймер вызывавается скриптом <code>OneMinTimer.lua</code> каждую минуту:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunrise_add_min &lt;</span><span style="color:#9ECBFF;">const</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">15</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunrise_hour, sunrise_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunrise</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">sunrise_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sunrise_min </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> sunrise_add_min</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> sunrise_min </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">59</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  sunrise_hour </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sunrise_hour </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  sunrise_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sunrise_min </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> sunrise_hour </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> sunrise_min </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(sunrise_hour </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;:&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> sunrise_min)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunrise_add_min &lt;</span><span style="color:#032F62;">const</span><span style="color:#24292E;">&gt; </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">15</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunrise_hour, sunrise_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunrise</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">sunrise_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sunrise_min </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> sunrise_add_min</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> sunrise_min </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">59</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  sunrise_hour </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sunrise_hour </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  sunrise_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sunrise_min </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> sunrise_hour </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> sunrise_min </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(sunrise_hour </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;:&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> sunrise_min)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>Данный скрипт напечатает время рассвета, через 15 минут после наступления, т.е. если 8:55 наступает рассвет, добавляем 15 минут, то скрипт сработает в 9:10. Можно задавать не более 60 минут.</p><h3 id="примеры-использования-астротаимера" tabindex="-1">Примеры использования астротаймера <a class="header-anchor" href="#примеры-использования-астротаимера" aria-label="Permalink to &quot;Примеры использования астротаймера&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunset_add_min &lt;</span><span style="color:#9ECBFF;">const</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunset_hour, sunset_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunset</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">sunset_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sunset_min </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> sunset_add_min</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> sunset_min </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">59</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  sunset_hour </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sunset_hour </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  sunset_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sunset_min </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> sunset_hour </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> sunset_min </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- Включает уличный свет через 20 минут после заката</span></span>
<span class="line"><span style="color:#E1E4E8;">  telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Включено уличное освещение&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  http.</span><span style="color:#79B8FF;">request</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;http://192.168.2.200:8888/objects/?object=MegaD3-8&amp;op=m&amp;m=extended&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunset_add_min &lt;</span><span style="color:#032F62;">const</span><span style="color:#24292E;">&gt; </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunset_hour, sunset_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunset</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">sunset_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sunset_min </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> sunset_add_min</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> sunset_min </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">59</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  sunset_hour </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sunset_hour </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  sunset_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sunset_min </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> sunset_hour </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> sunset_min </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- Включает уличный свет через 20 минут после заката</span></span>
<span class="line"><span style="color:#24292E;">  telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Включено уличное освещение&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  http.</span><span style="color:#005CC5;">request</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;http://192.168.2.200:8888/objects/?object=MegaD3-8&amp;op=m&amp;m=extended&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunrise_add_min &lt;</span><span style="color:#9ECBFF;">const</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> sunrise_hour, sunrise_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunrise</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">sunrise_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sunrise_min </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> sunrise_add_min</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> sunrise_min </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">59</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  sunrise_hour </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sunrise_hour </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  sunrise_min </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sunrise_min </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> sunrise_hour </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> sunrise_min </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- Открывает шторы после рассвета</span></span>
<span class="line"><span style="color:#E1E4E8;">  telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Шторы в гостинной открыты&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x5C0272FFFEC8A21B&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;position&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunrise_add_min &lt;</span><span style="color:#032F62;">const</span><span style="color:#24292E;">&gt; </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> sunrise_hour, sunrise_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunrise</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">sunrise_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sunrise_min </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> sunrise_add_min</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> sunrise_min </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">59</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  sunrise_hour </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sunrise_hour </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  sunrise_min </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sunrise_min </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> sunrise_hour </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> sunrise_min </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- Открывает шторы после рассвета</span></span>
<span class="line"><span style="color:#24292E;">  telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Шторы в гостинной открыты&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x5C0272FFFEC8A21B&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;position&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h3 id="определение-времени-суток-светлое-или-темное" tabindex="-1">Определение времени суток (светлое или темное) <a class="header-anchor" href="#определение-времени-суток-светлое-или-темное" aria-label="Permalink to &quot;Определение времени суток (светлое или темное)&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">sunrise_h, sunrise_m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunrise</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">sunset_h, sunset_m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">sunset</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">sunshine </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">60</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">(sunrise_h</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">60</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">sunrise_m) </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">60</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">(sunset_h</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">60</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">sunset_m)</span></span>
<span class="line"><span style="color:#6A737D;">-- sunshine -  булева переменная, показывает время суток, дневное или вечернее.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">sunrise_h, sunrise_m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunrise</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">sunset_h, sunset_m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">sunset</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">sunshine </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">60</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">(sunrise_h</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">60</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">sunrise_m) </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">60</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">(sunset_h</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">60</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">sunset_m)</span></span>
<span class="line"><span style="color:#6A737D;">-- sunshine -  булева переменная, показывает время суток, дневное или вечернее.</span></span></code></pre></div><h3 id="включение-звука-дверного-звонка-по-событию-звуковои-фаил-лежит-в-открытои-сети" tabindex="-1">Включение звука дверного звонка по событию (звуковой файл лежит в открытой сети) <a class="header-anchor" href="#включение-звука-дверного-звонка-по-событию-звуковои-фаил-лежит-в-открытои-сети" aria-label="Permalink to &quot;Включение звука дверного звонка по событию (звуковой файл лежит в открытой сети)&quot;">​</a></h3><p>192.168.1.5 - адрес другого шлюза. Нельзя запускать на самом себе таким образом, используйте объект audio.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">http.</span><span style="color:#79B8FF;">request</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;http://192.168.1.5/audio?action=setvolume&amp;value=100&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">http.</span><span style="color:#79B8FF;">request</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;http://192.168.1.5/audio?action=play&amp;url=http://funny-dog.surge.sh/door_bell.mp3&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">http.</span><span style="color:#005CC5;">request</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;http://192.168.1.5/audio?action=setvolume&amp;value=100&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">http.</span><span style="color:#005CC5;">request</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;http://192.168.1.5/audio?action=play&amp;url=http://funny-dog.surge.sh/door_bell.mp3&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="воспроизведение-звука-при-нажатии-кнопки-звонок" tabindex="-1">Воспроизведение звука при нажатии кнопки (звонок) <a class="header-anchor" href="#воспроизведение-звука-при-нажатии-кнопки-звонок" aria-label="Permalink to &quot;Воспроизведение звука при нажатии кнопки (звонок)&quot;">​</a></h2><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--zvonok.lua   скрипт ставим на датчик открытия двери если кнопка ON меняем на Single (одиночное нажатие)</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;ON&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  audio.</span><span style="color:#79B8FF;">setvolume</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  audio.</span><span style="color:#79B8FF;">playurl</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;http://funny-dog.surge.sh/door_bell.mp3&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--zvonok.lua   скрипт ставим на датчик открытия двери если кнопка ON меняем на Single (одиночное нажатие)</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ON&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  audio.</span><span style="color:#005CC5;">setvolume</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  audio.</span><span style="color:#005CC5;">playurl</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;http://funny-dog.surge.sh/door_bell.mp3&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h2 id="управляем-открытием-закрытием-привода-штор-tuya-с-помощью-zigbee-кнопки-wxkg01lm" tabindex="-1">Управляем открытием/закрытием привода штор Tuya с помощью zigbee кнопки WXKG01LM <a class="header-anchor" href="#управляем-открытием-закрытием-привода-штор-tuya-с-помощью-zigbee-кнопки-wxkg01lm" aria-label="Permalink to &quot;Управляем открытием/закрытием привода штор Tuya с помощью zigbee кнопки WXKG01LM&quot;">​</a></h2><p>Создаем сценарий curtian.lua:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Param</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;">  x </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string.gmatch</span><span style="color:#E1E4E8;">(str,</span><span style="color:#9ECBFF;">&#39;([^:]+)&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">table.insert</span><span style="color:#E1E4E8;">(p, x)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> remoteieee </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;">-- ieee адрес привода для штор</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> minlevel </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;">--зададим минимальный уровень</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> maxlevel </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;">--зададим максимальный уровень</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> btn</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;action&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (btn </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;single&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--при однократном нажатии переключим шторы в противоположный режим</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(remoteieee, </span><span style="color:#9ECBFF;">&quot;running&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> running </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(remoteieee, </span><span style="color:#9ECBFF;">&quot;running&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (running </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remoteieee, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;STOP&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> position </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(remoteieee, </span><span style="color:#9ECBFF;">&quot;position&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(position)</span><span style="color:#F97583;">&lt;=</span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(maxlevel)</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remoteieee, </span><span style="color:#9ECBFF;">&quot;position&quot;</span><span style="color:#E1E4E8;">, maxlevel)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remoteieee, </span><span style="color:#9ECBFF;">&quot;position&quot;</span><span style="color:#E1E4E8;">, minlevel)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (btn</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&quot;double&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--при двукратном  нажатии откроем шторы</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remoteieee, </span><span style="color:#9ECBFF;">&quot;position&quot;</span><span style="color:#E1E4E8;">, maxlevel)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (btn</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&quot;triple&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--при трехкратном  нажатии закроем шторы</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remoteieee, </span><span style="color:#9ECBFF;">&quot;position&quot;</span><span style="color:#E1E4E8;">, minlevel)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (btn</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&quot;long_release&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--при длительном  нажатии остановим привод</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remoteieee, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;STOP&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Param</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;">  x </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string.gmatch</span><span style="color:#24292E;">(str,</span><span style="color:#032F62;">&#39;([^:]+)&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">table.insert</span><span style="color:#24292E;">(p, x)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> remoteieee </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#6A737D;">-- ieee адрес привода для штор</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> minlevel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">] </span><span style="color:#6A737D;">--зададим минимальный уровень</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> maxlevel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">] </span><span style="color:#6A737D;">--зададим максимальный уровень</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> btn</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;action&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (btn </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;single&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--при однократном нажатии переключим шторы в противоположный режим</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(remoteieee, </span><span style="color:#032F62;">&quot;running&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> running </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(remoteieee, </span><span style="color:#032F62;">&quot;running&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (running </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remoteieee, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;STOP&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> position </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(remoteieee, </span><span style="color:#032F62;">&quot;position&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(position)</span><span style="color:#D73A49;">&lt;=</span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(maxlevel)</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remoteieee, </span><span style="color:#032F62;">&quot;position&quot;</span><span style="color:#24292E;">, maxlevel)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remoteieee, </span><span style="color:#032F62;">&quot;position&quot;</span><span style="color:#24292E;">, minlevel)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (btn</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&quot;double&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--при двукратном  нажатии откроем шторы</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remoteieee, </span><span style="color:#032F62;">&quot;position&quot;</span><span style="color:#24292E;">, maxlevel)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (btn</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&quot;triple&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--при трехкратном  нажатии закроем шторы</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remoteieee, </span><span style="color:#032F62;">&quot;position&quot;</span><span style="color:#24292E;">, minlevel)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (btn</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&quot;long_release&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--при длительном  нажатии остановим привод</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remoteieee, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;STOP&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>В разделе SB выключателя WXKG01LM в метрике action прописываем вызов сценария curtain.lua, ieee адрес привода Tuya, значение position при открытии и значение при закрытии.</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">curtain.lua,0x5C0272FFFECAAC69:0:75</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">curtain.lua,0x5C0272FFFECAAC69:0:75</span></span></code></pre></div><p>Теперь при однократном нажатии кнопки осуществляется переключение в противоположный режим, при двукратном - открытие, трекратном - закрытие.</p><h2 id="периодическое-включение-отключение-циркуляционного-насоса-по-таимеру" tabindex="-1">Периодическое включение/отключение циркуляционного насоса по таймеру <a class="header-anchor" href="#периодическое-включение-отключение-циркуляционного-насоса-по-таимеру" aria-label="Permalink to &quot;Периодическое включение/отключение циркуляционного насоса по таймеру&quot;">​</a></h2><p>onemintimer.lua:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--включаем цикруляцию ГВС каждые 10 минут</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">40</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x00124B001EC823EC&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;state_l1&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Цикруляция ГВС выключена&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x00124B001EC823EC&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;state_l1&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;ON&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Цикруляция ГВС включена&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--включаем цикруляцию ГВС каждые 10 минут</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">40</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x00124B001EC823EC&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;state_l1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Цикруляция ГВС выключена&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x00124B001EC823EC&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;state_l1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;ON&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Цикруляция ГВС включена&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">end</span></span></code></pre></div><h2 id="управление-адресными-светодиодами-подключенными-к-контроллеру-wled" tabindex="-1">Управление адресными светодиодами, подключенными к контроллеру <a href="https://github.com/Aircoookie/WLED" target="_blank" rel="noreferrer">WLED</a> <a class="header-anchor" href="#управление-адресными-светодиодами-подключенными-к-контроллеру-wled" aria-label="Permalink to &quot;Управление адресными светодиодами, подключенными к контроллеру [WLED](https://github.com/Aircoookie/WLED)&quot;">​</a></h2><p>WLED поддерживает множество вариантов управления, в том числе mqtt. Ниже собраны примеры кода на lua для управления через mqtt.</p><p>Управление и переключение режимов можно легко &quot;повесить&quot; на zigbee-кнопку, поддерживаеющие многократные нажатия.</p><h3 id="включение-переключение-режима" tabindex="-1">Включение, переключение режима <a class="header-anchor" href="#включение-переключение-режима" aria-label="Permalink to &quot;Включение, переключение режима&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">mqtt.</span><span style="color:#79B8FF;">pub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;wled/f6dafd&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;toggle&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">mqtt.</span><span style="color:#79B8FF;">pub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;wled/f6dafd&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;on&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">mqtt.</span><span style="color:#79B8FF;">pub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;wled/f6dafd&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;off&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">mqtt.</span><span style="color:#005CC5;">pub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;wled/f6dafd&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;toggle&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">mqtt.</span><span style="color:#005CC5;">pub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;wled/f6dafd&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;on&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">mqtt.</span><span style="color:#005CC5;">pub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;wled/f6dafd&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;off&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="установка-заданного-цвета" tabindex="-1">Установка заданного цвета <a class="header-anchor" href="#установка-заданного-цвета" aria-label="Permalink to &quot;Установка заданного цвета&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">mqtt.</span><span style="color:#79B8FF;">pub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;wled/f6dafd/col&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;#36A615DD&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">mqtt.</span><span style="color:#005CC5;">pub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;wled/f6dafd/col&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;#36A615DD&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="установка-произвольного-цвета" tabindex="-1">Установка произвольного цвета <a class="header-anchor" href="#установка-произвольного-цвета" aria-label="Permalink to &quot;Установка произвольного цвета&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">mqtt.</span><span style="color:#79B8FF;">pub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;wled/f6dafd/col&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;#&#39;</span><span style="color:#F97583;">..</span><span style="color:#79B8FF;">math.random</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16777215</span><span style="color:#E1E4E8;">))</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">mqtt.</span><span style="color:#005CC5;">pub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;wled/f6dafd/col&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;#&#39;</span><span style="color:#D73A49;">..</span><span style="color:#005CC5;">math.random</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16777215</span><span style="color:#24292E;">))</span></span></code></pre></div><h3 id="установка-произвольного-эффекта-и-отключение-эффектов" tabindex="-1">Установка произвольного эффекта и отключение эффектов <a class="header-anchor" href="#установка-произвольного-эффекта-и-отключение-эффектов" aria-label="Permalink to &quot;Установка произвольного эффекта и отключение эффектов&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">mqtt.</span><span style="color:#79B8FF;">pub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;wled/f6dafd/api&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;win&amp;A=128&amp;FX=&#39;</span><span style="color:#F97583;">..</span><span style="color:#79B8FF;">math.random</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">)) </span><span style="color:#6A737D;">-- установка произвольного эффекта</span></span>
<span class="line"><span style="color:#E1E4E8;">mqtt.</span><span style="color:#79B8FF;">pub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;wled/f6dafd/api&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;win&amp;A=128&amp;FX=0&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- отключение  эффектов</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">mqtt.</span><span style="color:#005CC5;">pub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;wled/f6dafd/api&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;win&amp;A=128&amp;FX=&#39;</span><span style="color:#D73A49;">..</span><span style="color:#005CC5;">math.random</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">50</span><span style="color:#24292E;">)) </span><span style="color:#6A737D;">-- установка произвольного эффекта</span></span>
<span class="line"><span style="color:#24292E;">mqtt.</span><span style="color:#005CC5;">pub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;wled/f6dafd/api&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;win&amp;A=128&amp;FX=0&#39;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- отключение  эффектов</span></span></code></pre></div><h2 id="оповещение-в-telegram-о-сработке-датчика-протечки" tabindex="-1">Оповещение в telegram о сработке датчика протечки <a class="header-anchor" href="#оповещение-в-telegram-о-сработке-датчика-протечки" aria-label="Permalink to &quot;Оповещение в telegram о сработке датчика протечки&quot;">​</a></h2><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&quot;water_leak&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (state) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Внимание!!! Сработал датчик протечки &quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">FriendlyName</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x000D6F001314C316&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;warning&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">  telegram.</span><span style="color:#79B8FF;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Протечка на датчике  &quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">FriendlyName</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; устранена&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&quot;water_leak&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (state) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Внимание!!! Сработал датчик протечки &quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">FriendlyName</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x000D6F001314C316&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;warning&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">  telegram.</span><span style="color:#005CC5;">send</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Протечка на датчике  &quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">FriendlyName</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; устранена&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h2 id="обработка-двоиного-троиного-и-тд-нажатия-на-выключателях-которые-не-поддерживают-такие-режимы" tabindex="-1">Обработка двойного, тройного и тд нажатия на выключателях, которые не поддерживают такие режимы <a class="header-anchor" href="#обработка-двоиного-троиного-и-тд-нажатия-на-выключателях-которые-не-поддерживают-такие-режимы" aria-label="Permalink to &quot;Обработка двойного, тройного и тд нажатия на выключателях, которые не поддерживают такие режимы&quot;">​</a></h2><p>Данный сценарий тестировался для выключателей, которые подключены к <a href="https://modkam.ru/2020/06/24/zigbee-rele-na-8-kanalov/" target="_blank" rel="noreferrer">8-ми канальному реле modkam</a> и привода для штор от Aqara. При первом нажатии создается таймер на 3 секунды, который инциирует действия.</p><p>callback.lua (привязывается в интерфейсе к каналу, который будем считать)</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">search_value</span><span style="color:#E1E4E8;"> (tbl, val)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">#</span><span style="color:#E1E4E8;">tbl </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> tbl[i][</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> val </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> i</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">~=</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">OldValue</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ar </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  {</span><span style="color:#9ECBFF;">&quot;0x00124B001EC84F3C.state_l8&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;0x00158D0002EE1285&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;cover&#39;</span><span style="color:#E1E4E8;">},  </span><span style="color:#6A737D;">--спальня</span></span>
<span class="line"><span style="color:#E1E4E8;">  {</span><span style="color:#9ECBFF;">&quot;0x00124B001F7CA144.state_l2&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;0x50325FFFFEA65978&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;cover&#39;</span><span style="color:#E1E4E8;">},  </span><span style="color:#6A737D;">--Анюта</span></span>
<span class="line"><span style="color:#E1E4E8;">  {</span><span style="color:#9ECBFF;">&quot;0x00124B001F7CA144.state_l8&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;0x50325FFFFEA457C4&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;cover&#39;</span><span style="color:#E1E4E8;">},  </span><span style="color:#6A737D;">--Софа</span></span>
<span class="line"><span style="color:#E1E4E8;">  {</span><span style="color:#9ECBFF;">&quot;0x00124B001EC80F20.state_l7&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;0x5C0272FFFECAAC69&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;cover&#39;</span><span style="color:#E1E4E8;">},  </span><span style="color:#6A737D;">--Гостиная</span></span>
<span class="line"><span style="color:#E1E4E8;">  {</span><span style="color:#9ECBFF;">&quot;0x00124B001EC84F3C.state_l7&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;hello&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;telega&#39;</span><span style="color:#E1E4E8;">}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  myevent </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">ieeeAddr</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;.&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Name</span></span>
<span class="line"><span style="color:#E1E4E8;">  remotedev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ar[</span><span style="color:#79B8FF;">search_value</span><span style="color:#E1E4E8;">(ar, myevent)][</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  remotetype </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ar[</span><span style="color:#79B8FF;">search_value</span><span style="color:#E1E4E8;">(ar, myevent)][</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  obj.</span><span style="color:#79B8FF;">setType</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_cnt&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;INT&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  obj.</span><span style="color:#79B8FF;">setType</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;BOOL&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  obj.</span><span style="color:#79B8FF;">setShare</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_cnt&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  obj.</span><span style="color:#79B8FF;">setShare</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  timer</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;_cnt&quot;</span><span style="color:#E1E4E8;">, obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_cnt&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--проверяем, если скрипт был запущен давно и не сбросился</span></span>
<span class="line"><span style="color:#E1E4E8;">  curr, prev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">getTime</span><span style="color:#E1E4E8;">(remotedev</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (timer </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> curr </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_cnt&quot; </span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--запускам таймер сброса на 3 сек</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (timer </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;clear_cnt&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">,remotedev)</span></span>
<span class="line"><span style="color:#E1E4E8;">    obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">search_value</span><span style="color:#24292E;"> (tbl, val)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">#</span><span style="color:#24292E;">tbl </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> tbl[i][</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> val </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> i</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">~=</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">OldValue</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ar </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  {</span><span style="color:#032F62;">&quot;0x00124B001EC84F3C.state_l8&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;0x00158D0002EE1285&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;cover&#39;</span><span style="color:#24292E;">},  </span><span style="color:#6A737D;">--спальня</span></span>
<span class="line"><span style="color:#24292E;">  {</span><span style="color:#032F62;">&quot;0x00124B001F7CA144.state_l2&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;0x50325FFFFEA65978&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;cover&#39;</span><span style="color:#24292E;">},  </span><span style="color:#6A737D;">--Анюта</span></span>
<span class="line"><span style="color:#24292E;">  {</span><span style="color:#032F62;">&quot;0x00124B001F7CA144.state_l8&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;0x50325FFFFEA457C4&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;cover&#39;</span><span style="color:#24292E;">},  </span><span style="color:#6A737D;">--Софа</span></span>
<span class="line"><span style="color:#24292E;">  {</span><span style="color:#032F62;">&quot;0x00124B001EC80F20.state_l7&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;0x5C0272FFFECAAC69&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;cover&#39;</span><span style="color:#24292E;">},  </span><span style="color:#6A737D;">--Гостиная</span></span>
<span class="line"><span style="color:#24292E;">  {</span><span style="color:#032F62;">&quot;0x00124B001EC84F3C.state_l7&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;hello&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;telega&#39;</span><span style="color:#24292E;">}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  myevent </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">ieeeAddr</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Name</span></span>
<span class="line"><span style="color:#24292E;">  remotedev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ar[</span><span style="color:#005CC5;">search_value</span><span style="color:#24292E;">(ar, myevent)][</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  remotetype </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ar[</span><span style="color:#005CC5;">search_value</span><span style="color:#24292E;">(ar, myevent)][</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  obj.</span><span style="color:#005CC5;">setType</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_cnt&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;INT&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  obj.</span><span style="color:#005CC5;">setType</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;BOOL&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  obj.</span><span style="color:#005CC5;">setShare</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_cnt&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  obj.</span><span style="color:#005CC5;">setShare</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  timer</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;_cnt&quot;</span><span style="color:#24292E;">, obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_cnt&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">--проверяем, если скрипт был запущен давно и не сбросился</span></span>
<span class="line"><span style="color:#24292E;">  curr, prev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">getTime</span><span style="color:#24292E;">(remotedev</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (timer </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> curr </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_cnt&quot; </span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">--запускам таймер сброса на 3 сек</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (timer </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;clear_cnt&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">,remotedev)</span></span>
<span class="line"><span style="color:#24292E;">    obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>Сценарий, который выполняет сами действия clear_cnt.lua</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">remotedev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Param</span></span>
<span class="line"><span style="color:#E1E4E8;">val </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_cnt&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (val </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_cnt&quot; </span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remotedev </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--telegram.send(val..&quot;, счетчик сброшен,&quot;..remotedev)</span></span>
<span class="line"><span style="color:#E1E4E8;">  scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;clear_cnt&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (val </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- telegram.send(&quot;val:&quot;..val)</span></span>
<span class="line"><span style="color:#E1E4E8;">  position</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(remotedev, </span><span style="color:#9ECBFF;">&quot;position&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- telegram.send(&quot;position:&quot;..position)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (position </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- telegram.send(&quot;закрываю шторы&quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">    zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remotedev, </span><span style="color:#9ECBFF;">&quot;position&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- telegram.send(&quot;открываю шторы&quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">    zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(remotedev, </span><span style="color:#9ECBFF;">&quot;position&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">remotedev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Param</span></span>
<span class="line"><span style="color:#24292E;">val </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_cnt&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (val </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_cnt&quot; </span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remotedev </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">--telegram.send(val..&quot;, счетчик сброшен,&quot;..remotedev)</span></span>
<span class="line"><span style="color:#24292E;">  scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;clear_cnt&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (val </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- telegram.send(&quot;val:&quot;..val)</span></span>
<span class="line"><span style="color:#24292E;">  position</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(remotedev, </span><span style="color:#032F62;">&quot;position&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- telegram.send(&quot;position:&quot;..position)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (position </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- telegram.send(&quot;закрываю шторы&quot;)</span></span>
<span class="line"><span style="color:#24292E;">    zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remotedev, </span><span style="color:#032F62;">&quot;position&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- telegram.send(&quot;открываю шторы&quot;)</span></span>
<span class="line"><span style="color:#24292E;">    zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(remotedev, </span><span style="color:#032F62;">&quot;position&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h2 id="отключение-света-через-15-минут-после-включения" tabindex="-1">Отключение света через 15 минут после включения <a class="header-anchor" href="#отключение-света-через-15-минут-после-включения" aria-label="Permalink to &quot;Отключение света через 15 минут после включения&quot;">​</a></h2><p>Данный сценарий тестировался для выключателей, которые подключены к <a href="https://modkam.ru/2020/06/24/zigbee-rele-na-8-kanalov/" target="_blank" rel="noreferrer">8-ми канальному реле modkam</a>. Сценарий удобно применять в помещениях, где пребывание обычно недолгое, например гардеробная комната, прихожая и т.д., где дети всегда часто забывают выключать свет. На всякий случай предусмотрим передачу параметров (если тригером будет не сам объект), для этого привяжем к управляемой линии вызов сценария toggle_timer</p><p><img src="`+t+`" alt="toggle_timer"></p><p>Сценарий toggle_timer.lua:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> waittime </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">900</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;">  x </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string.gmatch</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">Param</span><span style="color:#E1E4E8;"> ,</span><span style="color:#9ECBFF;">&#39;([^:]+)&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">table.insert</span><span style="color:#E1E4E8;">(p, x)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ieee </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> parname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> state </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(ieee, parname)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> timer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(ieee </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> parname </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;">  curr, prev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">getTime</span><span style="color:#E1E4E8;">(ieee </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> parname </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">obj.</span><span style="color:#79B8FF;">setType</span><span style="color:#E1E4E8;">(ieee </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> parname </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;BOOL&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">obj.</span><span style="color:#79B8FF;">setShare</span><span style="color:#E1E4E8;">(ieee </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> parname </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;">--сброс таймера, если по какойто причине таймер просрочен</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (state </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;ON&quot; </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> timer </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> curr </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> waittime </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> parname </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#6A737D;">--запускам таймер выключения</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (state </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;ON&quot; </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> timer </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;toggle_timer2&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> waittime, ieee </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;:&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> parname)</span></span>
<span class="line"><span style="color:#E1E4E8;">  obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> parname </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> waittime </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">900</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;">  x </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string.gmatch</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">Param</span><span style="color:#24292E;"> ,</span><span style="color:#032F62;">&#39;([^:]+)&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">table.insert</span><span style="color:#24292E;">(p, x)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ieee </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> parname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> state </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(ieee, parname)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> timer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(ieee </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> parname </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;">  curr, prev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">getTime</span><span style="color:#24292E;">(ieee </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> parname </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">obj.</span><span style="color:#005CC5;">setType</span><span style="color:#24292E;">(ieee </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> parname </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;BOOL&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">obj.</span><span style="color:#005CC5;">setShare</span><span style="color:#24292E;">(ieee </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> parname </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;">--сброс таймера, если по какойто причине таймер просрочен</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (state </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ON&quot; </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> timer </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> curr </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> waittime </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> parname </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#6A737D;">--запускам таймер выключения</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (state </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ON&quot; </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> timer </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;toggle_timer2&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> waittime, ieee </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;:&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> parname)</span></span>
<span class="line"><span style="color:#24292E;">  obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> parname </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>сценарий, который будет вызываться по таймеру (выключение света) toggle_timer2.lua:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">explode</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;:&quot;</span><span style="color:#E1E4E8;">, Event.</span><span style="color:#B392F0;">Param</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ieee </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> parname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee, parname, </span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">obj.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ieee</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> parname </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;_timer&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;">--telegram.send(ieee..&quot;.&quot;..parname..&quot; выключен по таймеру&quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;toggle_timer2&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">explode</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;:&quot;</span><span style="color:#24292E;">, Event.</span><span style="color:#6F42C1;">Param</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ieee </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> parname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee, parname, </span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">obj.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ieee</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> parname </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_timer&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;">--telegram.send(ieee..&quot;.&quot;..parname..&quot; выключен по таймеру&quot;)</span></span>
<span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;toggle_timer2&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="сохранение-значении-в-json-через-lua" tabindex="-1">Сохранение значений в json через lua <a class="header-anchor" href="#сохранение-значении-в-json-через-lua" aria-label="Permalink to &quot;Сохранение значений в json через lua&quot;">​</a></h2><p>Пример сценария для записи значений в локальное <a href="/storage">хранилище</a> (int или sd), сценарий сохраняет файл с именем файла, равным дате. В виду того, что для преобразования записанного файла в json используется память SLS, не рекомендуется запускать часто. В случае переполнения памяти, запись готового json не будет выполнена. Пример отображения <a href="/ui_graph">графиков</a> через ui.html.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> new_ust, prev_ust </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;thermo.boiler.target_temperature&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">--получение текущего значения уставки</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ul_ot, prev_ul_ot </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;thermo.boiler.temperature_outside&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#6A737D;">--получение уличной темпетуры с котла по ОТ</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> new_ds18, prev_ds18 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;1w.28-96A907D6013C/temperature&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">--получение  значения датчика температуры</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ul_bt, prev_bt </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;thermo.boiler.temperature&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#6A737D;">--получение температуры теплоносителя (отопления)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> new_dhwt, prev_dhwt </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;thermo.dhw.temperature&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">--получение температуры бойлера</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> dhwst, prev_dhwst </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;thermo.dhw.status&#39;</span><span style="color:#E1E4E8;">)       </span><span style="color:#6A737D;">--нагрев воды</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> flame, prev_flame </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;thermo.boiler.flame&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">--нагрев отопления</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> avr_temp,  avr_temp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> obj.</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;average_temp&#39;</span><span style="color:#E1E4E8;">)       </span><span style="color:#6A737D;">--средняя температура в доме</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (flame</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&quot;true&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> flame_status</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> flame_status</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--переназнчаем, так как почему-то значения хранятся в STRING</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (dhwst</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&quot;true&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> dhwst_status</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> dhwst_status</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--переназнчаем, так как почему-то значения хранятся в STRING</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> cdate</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">string.format</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%02d&quot;</span><span style="color:#E1E4E8;">, Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">day</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;/&quot;</span><span style="color:#F97583;">..</span><span style="color:#79B8FF;">string.format</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%02d&quot;</span><span style="color:#E1E4E8;">, Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">month</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;/&quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">year</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--приводим дату в нужный формат</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ctime</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">string.format</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%02d&quot;</span><span style="color:#E1E4E8;">, Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;:&quot;</span><span style="color:#F97583;">..</span><span style="color:#79B8FF;">string.format</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%02d&quot;</span><span style="color:#E1E4E8;">, Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;:&quot;</span><span style="color:#F97583;">..</span><span style="color:#79B8FF;">string.format</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%02d&quot;</span><span style="color:#E1E4E8;">, Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">sec</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">--приводим время  в нужный формат</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ctimesh</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">string.format</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%02d&quot;</span><span style="color:#E1E4E8;">, Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">hour</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;:&quot;</span><span style="color:#F97583;">..</span><span style="color:#79B8FF;">string.format</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%02d&quot;</span><span style="color:#E1E4E8;">, Event.</span><span style="color:#B392F0;">Time</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">--приводим время  в краткий формат</span></span>
<span class="line"><span style="color:#6A737D;">--local storage=&#39;int&#39;   --для записи во внутренню память</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> storage</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;sd&#39;      </span><span style="color:#6A737D;">--для записи на карту памяти</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> fn</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;/&quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">storage</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;/!log_&quot;</span><span style="color:#F97583;">..</span><span style="color:#79B8FF;">string.gsub</span><span style="color:#E1E4E8;">(cdate, </span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;_&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;.txt&quot;</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> fnjs</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;/&quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">storage</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;/!log_&quot;</span><span style="color:#F97583;">..</span><span style="color:#79B8FF;">string.gsub</span><span style="color:#E1E4E8;">(cdate, </span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;_&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;.json&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">os.</span><span style="color:#79B8FF;">fileWrite</span><span style="color:#E1E4E8;">(fn,</span><span style="color:#9ECBFF;">&#39;{&quot;new_ust&quot;:&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">new_ust</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&#39;,&quot;ul_ot&quot;:&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> ul_ot</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,&quot;new_ds18&quot;:&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">new_ds18</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&#39;,&quot;ul_bt&quot;:&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">ul_bt</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&#39;,&quot;new_dhwt&quot;:&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> new_dhwt </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,&quot;unixtime&quot;:&#39;</span><span style="color:#F97583;">..</span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">..</span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;,&quot;datetime&quot;:&quot;&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">cdate</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot; &quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">ctime</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&#39;&quot;,&quot;dhwt_status&quot;:&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> dhwst_status</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&#39;,&quot;flame_status&quot;:&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> flame_status</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&#39;,&quot;average_temp&quot;:&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> avr_temp</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&#39;,&quot;ctimesh&quot;:&quot;&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> ctimesh</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;&quot;},</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">fileRead</span><span style="color:#E1E4E8;">(fn)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> js</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;{&quot;temp&quot;:[&#39;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">value</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&#39;]}&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">js</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">string.gsub</span><span style="color:#E1E4E8;">(js, </span><span style="color:#9ECBFF;">&#39;,</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">]}&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">]}&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">os.</span><span style="color:#79B8FF;">fileWrite</span><span style="color:#E1E4E8;">(fnjs,js)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Список файлов доступен тут http://&quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">net.</span><span style="color:#79B8FF;">localIP</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;/api/storage?path=/&quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">storage</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;/&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> free</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">http.</span><span style="color:#79B8FF;">request2</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;http://&quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">net.</span><span style="color:#79B8FF;">localIP</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;/api/storage/info&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;http://&quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">net.</span><span style="color:#79B8FF;">localIP</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">..</span><span style="color:#9ECBFF;">&quot;/api/storage?path=&quot;</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">fnjs)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> new_ust, prev_ust </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;thermo.boiler.target_temperature&#39;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">--получение текущего значения уставки</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ul_ot, prev_ul_ot </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;thermo.boiler.temperature_outside&#39;</span><span style="color:#24292E;">)</span><span style="color:#6A737D;">--получение уличной темпетуры с котла по ОТ</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> new_ds18, prev_ds18 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;1w.28-96A907D6013C/temperature&#39;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">--получение  значения датчика температуры</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ul_bt, prev_bt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;thermo.boiler.temperature&#39;</span><span style="color:#24292E;">)</span><span style="color:#6A737D;">--получение температуры теплоносителя (отопления)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> new_dhwt, prev_dhwt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;thermo.dhw.temperature&#39;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">--получение температуры бойлера</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> dhwst, prev_dhwst </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;thermo.dhw.status&#39;</span><span style="color:#24292E;">)       </span><span style="color:#6A737D;">--нагрев воды</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> flame, prev_flame </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;thermo.boiler.flame&#39;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">--нагрев отопления</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> avr_temp,  avr_temp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> obj.</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;average_temp&#39;</span><span style="color:#24292E;">)       </span><span style="color:#6A737D;">--средняя температура в доме</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (flame</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> flame_status</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> flame_status</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--переназнчаем, так как почему-то значения хранятся в STRING</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (dhwst</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> dhwst_status</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> dhwst_status</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--переназнчаем, так как почему-то значения хранятся в STRING</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> cdate</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">string.format</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%02d&quot;</span><span style="color:#24292E;">, Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">day</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;/&quot;</span><span style="color:#D73A49;">..</span><span style="color:#005CC5;">string.format</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%02d&quot;</span><span style="color:#24292E;">, Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">month</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;/&quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">year</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--приводим дату в нужный формат</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ctime</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">string.format</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%02d&quot;</span><span style="color:#24292E;">, Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;:&quot;</span><span style="color:#D73A49;">..</span><span style="color:#005CC5;">string.format</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%02d&quot;</span><span style="color:#24292E;">, Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;:&quot;</span><span style="color:#D73A49;">..</span><span style="color:#005CC5;">string.format</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%02d&quot;</span><span style="color:#24292E;">, Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">sec</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">--приводим время  в нужный формат</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ctimesh</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">string.format</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%02d&quot;</span><span style="color:#24292E;">, Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">hour</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;:&quot;</span><span style="color:#D73A49;">..</span><span style="color:#005CC5;">string.format</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%02d&quot;</span><span style="color:#24292E;">, Event.</span><span style="color:#6F42C1;">Time</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">min</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">--приводим время  в краткий формат</span></span>
<span class="line"><span style="color:#6A737D;">--local storage=&#39;int&#39;   --для записи во внутренню память</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> storage</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;sd&#39;      </span><span style="color:#6A737D;">--для записи на карту памяти</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> fn</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;/&quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">storage</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;/!log_&quot;</span><span style="color:#D73A49;">..</span><span style="color:#005CC5;">string.gsub</span><span style="color:#24292E;">(cdate, </span><span style="color:#032F62;">&#39;/&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;_&#39;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;.txt&quot;</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> fnjs</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;/&quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">storage</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;/!log_&quot;</span><span style="color:#D73A49;">..</span><span style="color:#005CC5;">string.gsub</span><span style="color:#24292E;">(cdate, </span><span style="color:#032F62;">&#39;/&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;_&#39;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;.json&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">os.</span><span style="color:#005CC5;">fileWrite</span><span style="color:#24292E;">(fn,</span><span style="color:#032F62;">&#39;{&quot;new_ust&quot;:&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">new_ust</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&#39;,&quot;ul_ot&quot;:&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> ul_ot</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,&quot;new_ds18&quot;:&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">new_ds18</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&#39;,&quot;ul_bt&quot;:&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">ul_bt</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&#39;,&quot;new_dhwt&quot;:&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> new_dhwt </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,&quot;unixtime&quot;:&#39;</span><span style="color:#D73A49;">..</span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">..</span></span>
<span class="line"><span style="color:#032F62;">&#39;,&quot;datetime&quot;:&quot;&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">cdate</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot; &quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">ctime</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&#39;&quot;,&quot;dhwt_status&quot;:&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> dhwst_status</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&#39;,&quot;flame_status&quot;:&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> flame_status</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&#39;,&quot;average_temp&quot;:&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> avr_temp</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&#39;,&quot;ctimesh&quot;:&quot;&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> ctimesh</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;&quot;},</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">fileRead</span><span style="color:#24292E;">(fn)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> js</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;{&quot;temp&quot;:[&#39;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">value</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&#39;]}&#39;</span></span>
<span class="line"><span style="color:#24292E;">js</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">string.gsub</span><span style="color:#24292E;">(js, </span><span style="color:#032F62;">&#39;,</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">]}&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">]}&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">os.</span><span style="color:#005CC5;">fileWrite</span><span style="color:#24292E;">(fnjs,js)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Список файлов доступен тут http://&quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">net.</span><span style="color:#005CC5;">localIP</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;/api/storage?path=/&quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">storage</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;/&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> free</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">http.</span><span style="color:#005CC5;">request2</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;http://&quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">net.</span><span style="color:#005CC5;">localIP</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;/api/storage/info&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;http://&quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">net.</span><span style="color:#005CC5;">localIP</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">..</span><span style="color:#032F62;">&quot;/api/storage?path=&quot;</span><span style="color:#D73A49;">..</span><span style="color:#24292E;">fnjs)</span></span></code></pre></div><p><em>PS. Документ в разработке</em></p>`,184),y=[r];function E(i,F,u,d,q,C){return n(),a("div",null,y)}const g=s(c,[["render",E]]);export{A as __pageData,g as default};
