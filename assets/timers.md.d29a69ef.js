import{_ as s,o as a,c as n,Q as l}from"./chunks/framework.9b0cfcaf.js";const d=JSON.parse('{"title":"Таймеры","description":"","frontmatter":{},"headers":[],"relativePath":"timers.md","filePath":"timers.md"}'),p={name:"timers.md"},o=l(`<h1 id="таимеры" tabindex="-1">Таймеры <a class="header-anchor" href="#таимеры" aria-label="Permalink to &quot;Таймеры&quot;">​</a></h1><h2 id="введение" tabindex="-1">Введение <a class="header-anchor" href="#введение" aria-label="Permalink to &quot;Введение&quot;">​</a></h2><p>Шлюз может запускать скрипты с определенной периодичностью. Можно установить таймер запуска к любому скрипту, а так же отменить его.</p><p>Одному скрипту можно назначить только один таймер. Поэтому, если выполнить подряд несколько установок таймера для одного целевого скрипта, то настройка применяется из последней итерации.</p><p>Тип таймера передается в скрипт событием <code>Event.Type</code></p><h2 id="типы-таимеров" tabindex="-1">Типы таймеров <a class="header-anchor" href="#типы-таимеров" aria-label="Permalink to &quot;Типы таймеров&quot;">​</a></h2><h3 id="однократныи" tabindex="-1">Однократный <a class="header-anchor" href="#однократныи" aria-label="Permalink to &quot;Однократный&quot;">​</a></h3><p>Выполняется однократно в UNIX время. Дискретность 1 секунда. <code>Event.Type = 4</code>.</p><p>В моделях шлюза без микросхемы RTC, не следует инициализировать данный тип таймера в <code>init.lua</code>, поскольку UNIX время на момент инициализации таймера может быть не синхронизировано с NTP. Особенно при холодном старте.</p><p>Инициализация:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(script, </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> t[, Param])</span></span>
<span class="line"><span style="color:#6A737D;">-- script - STR, имя файла скрипта, без расширения \`lua\`</span></span>
<span class="line"><span style="color:#6A737D;">-- os.time() - функциия LUA, возвращает UNIX время на текущий момент в сек.</span></span>
<span class="line"><span style="color:#6A737D;">-- t - INT, уставка времени в сек.</span></span>
<span class="line"><span style="color:#6A737D;">-- Param - STR, аргументы, передаваемые в скрипт</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(script, </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> t[, Param])</span></span>
<span class="line"><span style="color:#6A737D;">-- script - STR, имя файла скрипта, без расширения \`lua\`</span></span>
<span class="line"><span style="color:#6A737D;">-- os.time() - функциия LUA, возвращает UNIX время на текущий момент в сек.</span></span>
<span class="line"><span style="color:#6A737D;">-- t - INT, уставка времени в сек.</span></span>
<span class="line"><span style="color:#6A737D;">-- Param - STR, аргументы, передаваемые в скрипт</span></span></code></pre></div><h3 id="периодическии" tabindex="-1">Периодический <a class="header-anchor" href="#периодическии" aria-label="Permalink to &quot;Периодический&quot;">​</a></h3><p>Выполняется с заданной периодичностью. Дискретность 1 секунда. <code>Event.Type = 5</code></p><p>Инициализация:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(script, t[, Param])</span></span>
<span class="line"><span style="color:#6A737D;">-- script - STR, имя файла скрипта, без расширения \`lua\`</span></span>
<span class="line"><span style="color:#6A737D;">-- t - INT, уставка времени в сек.</span></span>
<span class="line"><span style="color:#6A737D;">-- Param - STR, аргументы, передаваемые в скрипт</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(script, t[, Param])</span></span>
<span class="line"><span style="color:#6A737D;">-- script - STR, имя файла скрипта, без расширения \`lua\`</span></span>
<span class="line"><span style="color:#6A737D;">-- t - INT, уставка времени в сек.</span></span>
<span class="line"><span style="color:#6A737D;">-- Param - STR, аргументы, передаваемые в скрипт</span></span></code></pre></div><h3 id="cron" tabindex="-1">CRON <a class="header-anchor" href="#cron" aria-label="Permalink to &quot;CRON&quot;">​</a></h3><p>Таймер такой же и с таким же синтаксисом как <a href="https://ru.wikipedia.org/wiki/Cron" target="_blank" rel="noreferrer">UNIX cron</a>. Единственное отличие: расписание может быть только одно для одного скрипта. Добавлен в версии прошивки 2022.04.24d11. <code>Event.Type = 6</code>. Инициализация:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(script, crontab[, Param])</span></span>
<span class="line"><span style="color:#6A737D;">-- script - STR, имя файла скрипта, без расширения \`lua\`</span></span>
<span class="line"><span style="color:#6A737D;">-- crontab - STR, уставка времени в формате UNIX CRON</span></span>
<span class="line"><span style="color:#6A737D;">-- Param - STR, аргументы, передаваемые в скрипт</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(script, crontab[, Param])</span></span>
<span class="line"><span style="color:#6A737D;">-- script - STR, имя файла скрипта, без расширения \`lua\`</span></span>
<span class="line"><span style="color:#6A737D;">-- crontab - STR, уставка времени в формате UNIX CRON</span></span>
<span class="line"><span style="color:#6A737D;">-- Param - STR, аргументы, передаваемые в скрипт</span></span></code></pre></div><h2 id="отмена-таимеров" tabindex="-1">Отмена таймеров <a class="header-anchor" href="#отмена-таимеров" aria-label="Permalink to &quot;Отмена таймеров&quot;">​</a></h2><p>Для отмены любого типа таймера достаточно задать уставку времени равную 0:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(script, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;">-- script - STR, имя файла скрипта, без расширения \`lua\`</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(script, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;">-- script - STR, имя файла скрипта, без расширения \`lua\`</span></span></code></pre></div><h2 id="api-для-работы-с-таимерами" tabindex="-1">API для работы с таймерами <a class="header-anchor" href="#api-для-работы-с-таимерами" aria-label="Permalink to &quot;API для работы с таймерами&quot;">​</a></h2><h3 id="http-api" tabindex="-1"><a href="/Gateway/http_api#скрипты-lua">HTTP API</a> <a class="header-anchor" href="#http-api" aria-label="Permalink to &quot;[HTTP API](/http_api.md#скрипты-lua)&quot;">​</a></h3><p>Получить список скриптов с таймерами: <code>/api/scripts</code></p><p>Возвращает JSON объект вида:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">&quot;success&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">&quot;result&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;name&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;tickOneMinute&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;ts&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1676519822</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;interval&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;timeout&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1676519822</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;name&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;alarmClock&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;ts&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1676518562</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;cron&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;50 5 * * 1-5&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;name&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;tables&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;ts&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1676519836</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;timeout&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1676519896</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  ]</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">&quot;success&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">&quot;result&quot;</span><span style="color:#24292E;">: [</span></span>
<span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;name&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;tickOneMinute&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;ts&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1676519822</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;interval&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">60</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;timeout&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1676519822</span></span>
<span class="line"><span style="color:#24292E;">    },</span></span>
<span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;name&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;alarmClock&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;ts&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1676518562</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;cron&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;50 5 * * 1-5&quot;</span></span>
<span class="line"><span style="color:#24292E;">    },</span></span>
<span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;name&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;tables&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;ts&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1676519836</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;timeout&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1676519896</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  ]</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>Здесь:</p><ul><li><code>success</code> - результат выполнения API команды</li><li><code>result</code> - перечень скриптов с назначенными таймерами <ul><li><code>name</code> - имя скрипта</li><li><code>interval</code> - интервал периодического таймера</li><li><code>ts</code> - последнее время запуска скрипта</li><li><code>timeout</code> - время последней сработки интервального таймера или время когда должен сработать фиксированный таймер</li></ul></li></ul><h3 id="lua" tabindex="-1"><a href="/Gateway/lua">LUA</a> <a class="header-anchor" href="#lua" aria-label="Permalink to &quot;[LUA](/lua.md)&quot;">​</a></h3><h4 id="scripts-gettimer" tabindex="-1">scripts.getTimer() <a class="header-anchor" href="#scripts-gettimer" aria-label="Permalink to &quot;scripts.getTimer()&quot;">​</a></h4><p>Возвращает оставшееся время таймера для скрипта в секундах.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">remain_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> scripts.</span><span style="color:#79B8FF;">getTimer</span><span style="color:#E1E4E8;">(script)</span></span>
<span class="line"><span style="color:#6A737D;">-- script - STR, имя проверяемого скрипта</span></span>
<span class="line"><span style="color:#6A737D;">-- remain_seconds - INT, оставшееся время в сек. или 0 для Cron и если таймера нет</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">remain_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> scripts.</span><span style="color:#005CC5;">getTimer</span><span style="color:#24292E;">(script)</span></span>
<span class="line"><span style="color:#6A737D;">-- script - STR, имя проверяемого скрипта</span></span>
<span class="line"><span style="color:#6A737D;">-- remain_seconds - INT, оставшееся время в сек. или 0 для Cron и если таймера нет</span></span></code></pre></div><h2 id="примеры" tabindex="-1">Примеры <a class="header-anchor" href="#примеры" aria-label="Permalink to &quot;Примеры&quot;">​</a></h2><h3 id="запуск-скрипта-getmoney-lua-каждые-60-секунд" tabindex="-1">Запуск скрипта getMoney.lua каждые 60 секунд <a class="header-anchor" href="#запуск-скрипта-getmoney-lua-каждые-60-секунд" aria-label="Permalink to &quot;Запуск скрипта getMoney.lua каждые 60 секунд&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;getMoney&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;$&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;getMoney&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">60</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;$&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="запуск-скрипта-givemoney-lua-через-5-минут-однократно" tabindex="-1">Запуск скрипта giveMoney.lua через 5 минут, однократно <a class="header-anchor" href="#запуск-скрипта-givemoney-lua-через-5-минут-однократно" aria-label="Permalink to &quot;Запуск скрипта giveMoney.lua через 5 минут, однократно&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;giveMoney&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">300</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;giveMoney&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">300</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="узнать-когда-запустится-скрипт-givemoney-lua" tabindex="-1">Узнать когда запустится скрипт giveMoney.lua <a class="header-anchor" href="#узнать-когда-запустится-скрипт-givemoney-lua" aria-label="Permalink to &quot;Узнать когда запустится скрипт giveMoney.lua&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(scripts.</span><span style="color:#79B8FF;">getTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;giveMoney&quot;</span><span style="color:#E1E4E8;">))</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(scripts.</span><span style="color:#005CC5;">getTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;giveMoney&quot;</span><span style="color:#24292E;">))</span></span></code></pre></div><h3 id="запуск-скрипта-earnmoney-lua-каждыи-буднии-день-в-01-05" tabindex="-1">Запуск скрипта earnMoney.lua каждый будний день в 01:05 <a class="header-anchor" href="#запуск-скрипта-earnmoney-lua-каждыи-буднии-день-в-01-05" aria-label="Permalink to &quot;Запуск скрипта earnMoney.lua каждый будний день в 01:05&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;earnMoney&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;5 1 * * 1-5&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;earnMoney&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;5 1 * * 1-5&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="сброс-таимера-для-скрипта-onemintimer-lua" tabindex="-1">Сброс таймера для скрипта OneMinTimer.lua <a class="header-anchor" href="#сброс-таимера-для-скрипта-onemintimer-lua" aria-label="Permalink to &quot;Сброс таймера для скрипта OneMinTimer.lua&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;OneMinTimer&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;OneMinTimer&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="определить-тип-таимера" tabindex="-1">Определить тип таймера <a class="header-anchor" href="#определить-тип-таимера" aria-label="Permalink to &quot;Определить тип таймера&quot;">​</a></h3><p>Допустим, скрипт action.lua может запускаться по таймерам разного типа. Определение типа:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- action.lua</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Однократный таймер&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Периодический таймер&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Таймер CRON&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- action.lua</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Однократный таймер&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Периодический таймер&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Таймер CRON&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h3 id="отправка-данных-каждую-минуту-на-narodmon-ru" tabindex="-1">Отправка данных каждую минуту на narodmon.ru <a class="header-anchor" href="#отправка-данных-каждую-минуту-на-narodmon-ru" aria-label="Permalink to &quot;Отправка данных каждую минуту на narodmon.ru&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SendNarodmon</span><span style="color:#E1E4E8;">(name, value)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> MAC </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;BC:DD:C2:D7:68:BC&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  http.</span><span style="color:#79B8FF;">request</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;http://narodmon.ru/get?ID=&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> MAC </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&amp;&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> name </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;=&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(value))</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0x04CF8CDF3C771F6C&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;illuminance&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#79B8FF;">SendNarodmon</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;illuminance&quot;</span><span style="color:#E1E4E8;">, value)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SendNarodmon</span><span style="color:#24292E;">(name, value)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> MAC </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;BC:DD:C2:D7:68:BC&quot;</span></span>
<span class="line"><span style="color:#24292E;">  http.</span><span style="color:#005CC5;">request</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;http://narodmon.ru/get?ID=&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> MAC </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&amp;&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> name </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;=&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(value))</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0x04CF8CDF3C771F6C&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;illuminance&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">SendNarodmon</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;illuminance&quot;</span><span style="color:#24292E;">, value)</span></span></code></pre></div><h3 id="включение-выключение-света-в-аквариуме" tabindex="-1">Включение, выключение света в аквариуме <a class="header-anchor" href="#включение-выключение-света-в-аквариуме" aria-label="Permalink to &quot;Включение, выключение света в аквариуме&quot;">​</a></h3><p>Инициализация:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- init.lua</span></span>
<span class="line"><span style="color:#6A737D;">-- Аквариум</span></span>
<span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;aquarium&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;0 6 * * 1-5&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- Время включения 6:00 в будни. В параметр передаем число часов, через которое выключить</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- init.lua</span></span>
<span class="line"><span style="color:#6A737D;">-- Аквариум</span></span>
<span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;aquarium&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;0 6 * * 1-5&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- Время включения 6:00 в будни. В параметр передаем число часов, через которое выключить</span></span></code></pre></div><p>Вариант обработки таймера</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- aquarium.lua</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- скрипт вызван по CRON</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0xA4C138E56B96596D&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;ON&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- включить</span></span>
<span class="line"><span style="color:#E1E4E8;">  scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;aquarium&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">Param</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3600</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- настроить скрипт на запуска через кол-во часов переданных аргументом</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> (Event.</span><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;0xA4C138E56B96596D&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- выключить</span></span>
<span class="line"><span style="color:#E1E4E8;">  scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;aquarium&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;0 6 * * 1-5&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- установить таймер для следующего включения света</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- aquarium.lua</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- скрипт вызван по CRON</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0xA4C138E56B96596D&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;ON&quot;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- включить</span></span>
<span class="line"><span style="color:#24292E;">  scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;aquarium&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">Param</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3600</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- настроить скрипт на запуска через кол-во часов переданных аргументом</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> (Event.</span><span style="color:#6F42C1;">Type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;0xA4C138E56B96596D&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- выключить</span></span>
<span class="line"><span style="color:#24292E;">  scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;aquarium&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;0 6 * * 1-5&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- установить таймер для следующего включения света</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h3 id="будильник" tabindex="-1">Будильник <a class="header-anchor" href="#будильник" aria-label="Permalink to &quot;Будильник&quot;">​</a></h3><p>Алгоритм:</p><ul><li>в 5:50 включить ночник</li><li>через 10 минут включить основной свет с небольшой яркостью</li><li>еще через пару минут выключить ночник и поднять яркость основного света до 100%</li></ul><p>Инициализация:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;alarmClock&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;alarmClock&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">60</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span></code></pre></div><p>Обработка:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- Будильник</span></span>
<span class="line"><span style="color:#6A737D;">--[[ Формат вызова в init.lua: scripts.setTimer(&quot;alarmClock&quot;, 60, 0)</span></span>
<span class="line"><span style="color:#6A737D;">Параметром передается тип будильника: 0 - инициализация; 1 - ночник; 2 - свет на 50%; 3 - свет на 100% ]]</span></span>
<span class="line"><span style="color:#6A737D;">-- Настройки:</span></span>
<span class="line"><span style="color:#6A737D;">-- Время запуска будильника:</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> cronMinutes </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- минуты</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> cronHours </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- часы</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> cronDaysOfWeek </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;1-5&quot; </span><span style="color:#6A737D;">-- в какие дни недели: 1-5 = пн-пт; 1,2,3 = пн,вт,ср</span></span>
<span class="line"><span style="color:#6A737D;">-- &quot;50 5 * * 1-5&quot;</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> cronTab </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tostring</span><span style="color:#E1E4E8;">(cronMinutes </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> cronHours </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; * * &#39; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> cronDaysOfWeek)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> timeLight1 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">660</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- сек., таймаут до включения света на 50%</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> timeLight2 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">120</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- сек., таймаут до включения света на 100%</span></span>
<span class="line"><span style="color:#6A737D;">-- Main</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> alarmType </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(Event.</span><span style="color:#B392F0;">Param</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (alarmType </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- 0 = инициализация</span></span>
<span class="line"><span style="color:#E1E4E8;">  scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;alarmClock&quot;</span><span style="color:#E1E4E8;">, cronTab, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- настройка на запуск по Cron на время cronTab</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> (alarmType </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- первый - включить ночник</span></span>
<span class="line"><span style="color:#E1E4E8;">  scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;alarmClock&quot;</span><span style="color:#E1E4E8;">, timeLight1, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- запуск данного скрипта через 10 минут на вкл света на 50%</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lmp_bedroom-nightlight&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- включить ночник через якость = 1</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> (alarmType </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;alarmClock&quot;</span><span style="color:#E1E4E8;">, timeLight2, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- запуск данного скрипта через 10 минут на вкл света на max</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lmp_bedroom&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- включить Люстру через якость = 50%</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> (alarmType </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;alarmClock&quot;</span><span style="color:#E1E4E8;">, cronTab, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- настройка на запуск по Cron на время cronTab</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lmp_bedroom-nightlight&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;state&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- выключить ночник</span></span>
<span class="line"><span style="color:#E1E4E8;">  zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;lmp_bedroom&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;brightness&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">-- включить Люстру через якость = 100%</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- Будильник</span></span>
<span class="line"><span style="color:#6A737D;">--[[ Формат вызова в init.lua: scripts.setTimer(&quot;alarmClock&quot;, 60, 0)</span></span>
<span class="line"><span style="color:#6A737D;">Параметром передается тип будильника: 0 - инициализация; 1 - ночник; 2 - свет на 50%; 3 - свет на 100% ]]</span></span>
<span class="line"><span style="color:#6A737D;">-- Настройки:</span></span>
<span class="line"><span style="color:#6A737D;">-- Время запуска будильника:</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> cronMinutes </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- минуты</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> cronHours </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- часы</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> cronDaysOfWeek </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;1-5&quot; </span><span style="color:#6A737D;">-- в какие дни недели: 1-5 = пн-пт; 1,2,3 = пн,вт,ср</span></span>
<span class="line"><span style="color:#6A737D;">-- &quot;50 5 * * 1-5&quot;</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> cronTab </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tostring</span><span style="color:#24292E;">(cronMinutes </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> cronHours </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; * * &#39; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> cronDaysOfWeek)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> timeLight1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">660</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- сек., таймаут до включения света на 50%</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> timeLight2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">120</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- сек., таймаут до включения света на 100%</span></span>
<span class="line"><span style="color:#6A737D;">-- Main</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> alarmType </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(Event.</span><span style="color:#6F42C1;">Param</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (alarmType </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- 0 = инициализация</span></span>
<span class="line"><span style="color:#24292E;">  scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;alarmClock&quot;</span><span style="color:#24292E;">, cronTab, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- настройка на запуск по Cron на время cronTab</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> (alarmType </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- первый - включить ночник</span></span>
<span class="line"><span style="color:#24292E;">  scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;alarmClock&quot;</span><span style="color:#24292E;">, timeLight1, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- запуск данного скрипта через 10 минут на вкл света на 50%</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lmp_bedroom-nightlight&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- включить ночник через якость = 1</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> (alarmType </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;alarmClock&quot;</span><span style="color:#24292E;">, timeLight2, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- запуск данного скрипта через 10 минут на вкл света на max</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lmp_bedroom&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- включить Люстру через якость = 50%</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> (alarmType </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;alarmClock&quot;</span><span style="color:#24292E;">, cronTab, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- настройка на запуск по Cron на время cronTab</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lmp_bedroom-nightlight&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;state&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- выключить ночник</span></span>
<span class="line"><span style="color:#24292E;">  zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lmp_bedroom&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;brightness&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">-- включить Люстру через якость = 100%</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p><strong>Внимание, скрипты OneMinTimer.lua и OneSecTimer.lua, начиная с версии прошивки 2022.01.30d1, не запускаются автоматически!!!</strong></p>`,61),e=[o];function t(c,r,y,E,i,u){return a(),n("div",null,e)}const C=s(p,[["render",t]]);export{d as __pageData,C as default};
