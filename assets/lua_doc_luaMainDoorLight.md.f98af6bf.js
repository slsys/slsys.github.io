import{_ as s,o as a,c as n,Q as l}from"./chunks/framework.f1c0562b.js";const A=JSON.parse('{"title":"Управление светом. Датчик открытия, кнопка, таймер.","description":"","frontmatter":{},"headers":[],"relativePath":"lua_doc/luaMainDoorLight.md","filePath":"lua_doc/luaMainDoorLight.md"}'),p={name:"lua_doc/luaMainDoorLight.md"},o=l(`<nav class="table-of-contents"><ul><li><a href="#введение">Введение</a></li><li><a href="#листинг">Листинг</a></li><li><a href="#описание">Описание</a></li></ul></nav><h1 id="управление-светом-датчик-открытия-кнопка-таимер" tabindex="-1">Управление светом. Датчик открытия, кнопка, таймер. <a class="header-anchor" href="#управление-светом-датчик-открытия-кнопка-таимер" aria-label="Permalink to &quot;Управление светом. Датчик открытия, кнопка, таймер.&quot;">​</a></h1><h2 id="введение" tabindex="-1">Введение <a class="header-anchor" href="#введение" aria-label="Permalink to &quot;Введение&quot;">​</a></h2><p>Функции:</p><ul><li>включение света по сработке датчика открытия</li><li>отключение по таймеру, для настройки которого не требуется править скрипт</li><li>при сработке датчика во время работы таймера, последний продлевается</li><li>включение света по кнопке</li><li>выключение света и таймера безусловно по кнопке</li><li>отключение таймера по длинному нажатию кнопки, с подтверждением подсветкой шлюза</li><li>отключение света внешним скриптом, например Peoples Tracker</li><li>все действия обрабатываются одним скриптом через рекурсивный вызов</li><li>ToDo - Если свет выключили кнопкой, то не включать свет при открытии двери в течение 1 минуты</li></ul><p>Скрипт разрабатывался и тестировался на SLS с прошивкой 2022.11.26d1. Его с легкостью можно адаптировать под похожие задачи.</p><p>В проекте использованы следующие устройства:</p><ul><li>магнитный датчик открытия Xiaomi . СМК потому-что в доме животные и датчик движения не особенно подходит, а датчик присутствия использовать здесь не оправдано дорого</li><li>кнопка Xiaomi (круглая), которая умеет различать разные варианты нажатия</li><li>реле TUYA Zigbee 3.0 Mini Smart Switch</li><li>my mind)</li></ul><p>При разработке хотелось все делать одним скриптом. Получилось). Скрипт не простой, но если новички его осилят, то смогут серьезно поднять свой скилл)</p><h2 id="листинг" tabindex="-1">Листинг <a class="header-anchor" href="#листинг" aria-label="Permalink to &quot;Листинг&quot;">​</a></h2><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- mainDoorOnOffLight.lua --</span></span>
<span class="line"><span style="color:#6A737D;">-- Пример правил Simple Bind:</span></span>
<span class="line"><span style="color:#6A737D;">-- Датчик: mainDoorOnOffLight.lua,mag|false|0x4F61|state|ON|300</span></span>
<span class="line"><span style="color:#6A737D;">-- Кнопка: mainDoorOnOffLight.lua,btn|X|0x4F61|state|X|1800</span></span>
<span class="line"><span style="color:#6A737D;">-- формат вызова скрипта scriptName,caller|srcStateTarget|dstDevice|dstState|dstStateVal|timer</span></span>
<span class="line"><span style="color:#6A737D;">-- разбираю аргументы </span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> arr </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">explode</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;|&quot;</span><span style="color:#E1E4E8;">, Event.</span><span style="color:#B392F0;">Param</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> arr[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;">-- кто вызвал: mag = СМК; btn = кнопка; timer = таймер; track = Трекер</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> srcStateTarget </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> arr[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;">--[[ целевое состояние вызывающего устройства, которое необходимо контролировать. Например, для СМК скрипт вызывается по изменению состояния сенсора contact. Если нужно, чтобы скрипт сработал при размыкании СМК (открытие двери/окна), то прописать false]]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> dstDevice </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> arr[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;">-- исполняющее устройство (реле/розетка/лампа), прописать ieeeAddr или nwkAddr или Friendly name</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> dstState </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> arr[</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;">-- состояние исполняющего устройства, которым необходимо управлять. Как правило - state</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> dstStateVal </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> arr[</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;">-- значение состояния исполняющего устройства, которое необходимо передать для получения результата. Как правило ON или OFF - вкл/выкл или TOGGLE - переключить</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> timer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> arr[</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;">-- таймер в сек</span></span>
<span class="line"><span style="color:#E1E4E8;">arr </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- cleanup</span></span>
<span class="line"><span style="color:#6A737D;">-- принимаю статус вызвавшего устройства</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> srcStateCurr</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  srcStateCurr </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Event.</span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> scriptName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">explode</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;.&quot;</span><span style="color:#E1E4E8;">, Event.</span><span style="color:#B392F0;">Name</span><span style="color:#E1E4E8;">))[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;">-- имя данного скрипта</span></span>
<span class="line"><span style="color:#6A737D;">-- проверяю кто вызвал (а-ля switch-case)</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (caller </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;mag&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- датчик открытия - надо включить свет</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- если srcStateCurr = srcStateTarget, значит открыли дверь</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (srcStateCurr </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> srcStateTarget) </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- задать/продлить таймер на запуск скрипту себя через время timer</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> param </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;timer|X|&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> dstDevice </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;|&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> dstState </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;|OFF&quot; </span><span style="color:#6A737D;">-- меняю целевое воздействие на OFF</span></span>
<span class="line"><span style="color:#E1E4E8;">    scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(scriptName, </span><span style="color:#79B8FF;">os.time</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> timer, param)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(dstDevice, dstState) </span><span style="color:#F97583;">~=</span><span style="color:#E1E4E8;"> dstStateVal) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- если свет (реле) выключен</span></span>
<span class="line"><span style="color:#E1E4E8;">      zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(dstDevice, dstState, dstStateVal) </span><span style="color:#6A737D;">-- то включить</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> (caller </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;btn&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- кнопка: single - переключить свет; long - отключить таймер и TODO неплохо бы моргнуть шлюзом для подтверждения</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (srcStateCurr </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;single&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- безусловно переключить свет и отключить таймер</span></span>
<span class="line"><span style="color:#E1E4E8;">	zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(dstDevice, dstState, </span><span style="color:#9ECBFF;">&quot;TOGGLE&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(scriptName, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> (srcStateCurr </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;long&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- если свет включен, отключить таймер и моргнуть шлюзом</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(dstDevice, dstState) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;ON&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(scriptName, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	  </span><span style="color:#6A737D;">-- моргнуть шлюзом для подтверждения</span></span>
<span class="line"><span style="color:#E1E4E8;">      os.</span><span style="color:#79B8FF;">led</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;ON&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">250</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	  os.</span><span style="color:#79B8FF;">delay</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">500</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	  os.</span><span style="color:#79B8FF;">led</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;OFF&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> (caller </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;track&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- вызов из трекера, вероятно для выключения. по таймеру тоже действие</span></span>
<span class="line"><span style="color:#E1E4E8;">  caller </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;timer&quot; </span><span style="color:#6A737D;">-- а-ля goto timer :)</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;"> (caller </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;timer&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- вернулся по окончанию таймера</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (zigbee.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(dstDevice, dstState) </span><span style="color:#F97583;">~=</span><span style="color:#E1E4E8;"> dstStateVal) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- если свет (реле) включен</span></span>
<span class="line"><span style="color:#E1E4E8;">    zigbee.</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(dstDevice, dstState, dstStateVal) </span><span style="color:#6A737D;">-- то выключить</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- обнулить таймер - по идее - удаление задачи планировщика</span></span>
<span class="line"><span style="color:#E1E4E8;">    scripts.</span><span style="color:#79B8FF;">setTimer</span><span style="color:#E1E4E8;">(scriptName, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- mainDoorOnOffLight.lua --</span></span>
<span class="line"><span style="color:#6A737D;">-- Пример правил Simple Bind:</span></span>
<span class="line"><span style="color:#6A737D;">-- Датчик: mainDoorOnOffLight.lua,mag|false|0x4F61|state|ON|300</span></span>
<span class="line"><span style="color:#6A737D;">-- Кнопка: mainDoorOnOffLight.lua,btn|X|0x4F61|state|X|1800</span></span>
<span class="line"><span style="color:#6A737D;">-- формат вызова скрипта scriptName,caller|srcStateTarget|dstDevice|dstState|dstStateVal|timer</span></span>
<span class="line"><span style="color:#6A737D;">-- разбираю аргументы </span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> arr </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">explode</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;|&quot;</span><span style="color:#24292E;">, Event.</span><span style="color:#6F42C1;">Param</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> arr[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#6A737D;">-- кто вызвал: mag = СМК; btn = кнопка; timer = таймер; track = Трекер</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> srcStateTarget </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> arr[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">] </span><span style="color:#6A737D;">--[[ целевое состояние вызывающего устройства, которое необходимо контролировать. Например, для СМК скрипт вызывается по изменению состояния сенсора contact. Если нужно, чтобы скрипт сработал при размыкании СМК (открытие двери/окна), то прописать false]]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> dstDevice </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> arr[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">] </span><span style="color:#6A737D;">-- исполняющее устройство (реле/розетка/лампа), прописать ieeeAddr или nwkAddr или Friendly name</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> dstState </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> arr[</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">] </span><span style="color:#6A737D;">-- состояние исполняющего устройства, которым необходимо управлять. Как правило - state</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> dstStateVal </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> arr[</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">] </span><span style="color:#6A737D;">-- значение состояния исполняющего устройства, которое необходимо передать для получения результата. Как правило ON или OFF - вкл/выкл или TOGGLE - переключить</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> timer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> arr[</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">] </span><span style="color:#6A737D;">-- таймер в сек</span></span>
<span class="line"><span style="color:#24292E;">arr </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- cleanup</span></span>
<span class="line"><span style="color:#6A737D;">-- принимаю статус вызвавшего устройства</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> srcStateCurr</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  srcStateCurr </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Event.</span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> scriptName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">explode</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;.&quot;</span><span style="color:#24292E;">, Event.</span><span style="color:#6F42C1;">Name</span><span style="color:#24292E;">))[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#6A737D;">-- имя данного скрипта</span></span>
<span class="line"><span style="color:#6A737D;">-- проверяю кто вызвал (а-ля switch-case)</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (caller </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;mag&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- датчик открытия - надо включить свет</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- если srcStateCurr = srcStateTarget, значит открыли дверь</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (srcStateCurr </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> srcStateTarget) </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- задать/продлить таймер на запуск скрипту себя через время timer</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> param </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;timer|X|&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> dstDevice </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;|&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> dstState </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;|OFF&quot; </span><span style="color:#6A737D;">-- меняю целевое воздействие на OFF</span></span>
<span class="line"><span style="color:#24292E;">    scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(scriptName, </span><span style="color:#005CC5;">os.time</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> timer, param)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(dstDevice, dstState) </span><span style="color:#D73A49;">~=</span><span style="color:#24292E;"> dstStateVal) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- если свет (реле) выключен</span></span>
<span class="line"><span style="color:#24292E;">      zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(dstDevice, dstState, dstStateVal) </span><span style="color:#6A737D;">-- то включить</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">end</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> (caller </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;btn&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- кнопка: single - переключить свет; long - отключить таймер и TODO неплохо бы моргнуть шлюзом для подтверждения</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (srcStateCurr </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;single&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- безусловно переключить свет и отключить таймер</span></span>
<span class="line"><span style="color:#24292E;">	zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(dstDevice, dstState, </span><span style="color:#032F62;">&quot;TOGGLE&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(scriptName, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> (srcStateCurr </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;long&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- если свет включен, отключить таймер и моргнуть шлюзом</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(dstDevice, dstState) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ON&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(scriptName, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	  </span><span style="color:#6A737D;">-- моргнуть шлюзом для подтверждения</span></span>
<span class="line"><span style="color:#24292E;">      os.</span><span style="color:#005CC5;">led</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;ON&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">250</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	  os.</span><span style="color:#005CC5;">delay</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">500</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	  os.</span><span style="color:#005CC5;">led</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;OFF&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> (caller </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;track&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- вызов из трекера, вероятно для выключения. по таймеру тоже действие</span></span>
<span class="line"><span style="color:#24292E;">  caller </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;timer&quot; </span><span style="color:#6A737D;">-- а-ля goto timer :)</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;"> (caller </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;timer&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- вернулся по окончанию таймера</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (zigbee.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(dstDevice, dstState) </span><span style="color:#D73A49;">~=</span><span style="color:#24292E;"> dstStateVal) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- если свет (реле) включен</span></span>
<span class="line"><span style="color:#24292E;">    zigbee.</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(dstDevice, dstState, dstStateVal) </span><span style="color:#6A737D;">-- то выключить</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- обнулить таймер - по идее - удаление задачи планировщика</span></span>
<span class="line"><span style="color:#24292E;">    scripts.</span><span style="color:#005CC5;">setTimer</span><span style="color:#24292E;">(scriptName, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h2 id="описание" tabindex="-1">Описание <a class="header-anchor" href="#описание" aria-label="Permalink to &quot;Описание&quot;">​</a></h2><p>Скрипт практически полностью исключает его правку в процессе эксплуатации, после внедрения. Для этого в него передаются параметры, позволяющие практически все настройки выполнять из интерфейса управления правилами Simple Bind. Описание параметров и формата вызова см. в листинге.</p>`,13),e=[o];function t(c,r,y,E,i,F){return a(),n("div",null,e)}const d=s(p,[["render",t]]);export{A as __pageData,d as default};
